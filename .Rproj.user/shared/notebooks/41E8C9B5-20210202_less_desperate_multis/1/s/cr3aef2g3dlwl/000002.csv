"0","# Make a list of metrics to calculate."
"0","hsi.metrics <- c('lsm_l_sidi')"
"0",""
"0","# Make a function to do the calculations and formatting."
"0","calc.hsi.metrics <- function(x) {"
"0","  sample_lsm(r.hsi, y=sites.sf, size=x, plot_id=site.names, shape='circle', "
"0","             what=hsi.metrics) %>% "
"0","    left_join(hsi.levels, by=c('class'='ID')) %>% "
"0","    mutate(class.name=ifelse(is.na(class.name), metric, class.name)) %>% "
"0","    select(-class, -metric, -level) %>%  "
"0","    pivot_wider(names_from=class.name, values_from=value) %>% "
"0","    mutate(radius=x) %>% "
"0","    rename(hsi.inside=percentage_inside)"
"0","}"
"0",""
"0","# Run the function for each sample size."
"0","hsi.landscape.metrics <- map_df(landscape$radius, calc.hsi.metrics)"
"0",""
"0","# Do some cleanup"
"0","hsi.landscape.metrics <- hsi.landscape.metrics %>% "
"0","  select(radius, hsi.inside, nest=plot_id, hsi.diversity=sidi)"
"0",""
"0","hsi.landscape.metrics <- select(landscape, radius, size) %>% right_join(hsi.landscape.metrics, by=c('radius'))"
"0",""
"0","# Join to data frame."
"0","df <- left_join(df, hsi.landscape.metrics, by=c('site'='nest', 'size', 'radius', 'hsi.inside'))"
