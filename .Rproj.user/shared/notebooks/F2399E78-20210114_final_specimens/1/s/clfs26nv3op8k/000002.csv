"0","# Import conflict settings."
"0","source('../src/conflicted.R')"
"0",""
"0","#Load some libraries."
"0","library(tidyverse)"
"0","library(ggplot2)"
"0","library(lubridate)"
"0","library(vegan)"
"0",""
"0","# Let's name some colors."
"0","aves <- '#89b0ae'"
"0","mammalia <- '#e9c46a'"
"0","unknown <- 'lightgrey'"
"0","bird <- '#114b5f' # Midnight green eagle"
"0","corvid <- '#7c9eb2' # Pewter blue"
"0","grouse <- '#c3e8bd' # Tea green"
"0","hare <- '#d1603d' # Copper red"
"0","mammal <- '#cdc392' # Sage"
"0","squirrel <- '#df9a57' # Persian orange"
"0","thrush <- '#553e4e' # Eggplant"
"0",""
"0","# Bring in diet data."
"0","remains.data <- read_csv('../data/raw/20210118_specimens.csv', guess_max=7000) %>% "
"0","  ## filter only records with at least size assigned..."
"0","  filter(size != 'U') %>% "
"0","  ## and rename a confusing column."
"0","  rename(name=site)"
"0",""
"0","# Bring in a list of site abbreviations and site names."
"0","nest.list <- read_csv('../data/processed/site_abbreviations.csv')"
"0",""
"0","# Join the site list to the remains data by site name."
"0","remains.data <- left_join(remains.data, nest.list, by='name')"
"0",""
"0","# Add a unique site/year identifier."
"0","remains.data <- remains.data %>% "
"0","  mutate(year=year(date), nest=paste(site, year, sep=''))"
"0",""
"0","# Select just the relevant columns..."
"0","remains.data <- remains.data %>% "
"0","  select(id, site, year, nest, class, order, family, genus, species, common, size, source) %>% "
"0","  ## then change the size column wording to make it look nicer..."
"0","  mutate(size=case_when("
"0","    size == 'S' ~ 'small',"
"0","    size == 'M' ~ 'medium',"
"0","    size == 'L' ~ 'large'"
"0","  )) %>% "
"0","  ## and replace all the ""U""s with ""Unknown""..."
"0","  mutate_at(c('class', 'order', 'family', 'genus'), funs(case_when("
"0","    . == 'U' ~ 'Unknown',"
"0","    TRUE ~ ."
"0","  ))) %>% "
"0","  ## in species as well..."
"0","  mutate(species=case_when("
"0","    species == 'U' ~ 'unknown',"
"0","    TRUE ~ species"
"0","  ))"
"0",""
"0","# Make sure species is lowercase."
"0","remains.data$species <- str_to_lower(remains.data$species)"
"0",""
"0","# Bring in a list of all known prey."
"0","prey.list <- read_csv('../data/interim/prey_attributes.csv')"
"0",""
"0","# Join the biomass data to the list of diet items."
"0","diet.items <- prey.list %>% select(genus, species, binomial, common, category, mass) %>% "
"0","  right_join(remains.data, by=c('genus', 'species', 'common'))"
"0",""
"0","# For unidentified items, classify them by size and class."
"0","diet.items <- diet.items %>% mutate(category=case_when("
"0","  is.na(category) & class == 'Mammalia' & size == 'small' ~ 'small mammal',"
"0","  is.na(category) & class == 'Mammalia' & size == 'medium' ~ 'medium mammal',"
"0","  is.na(category) & class == 'Mammalia' & size == 'large' ~ 'large mammal',"
"0","  is.na(category) & class == 'Aves' & size == 'small' ~ 'small bird',"
"0","  is.na(category) & class == 'Aves' & size == 'medium' ~ 'medium bird',"
"0","  is.na(category) & class == 'Aves' & size == 'large' ~ 'large bird',"
"0","  is.na(category) & class == 'Unknown' ~ paste(size, 'item'),"
"0","  TRUE ~ category))"
"0",""
"0","# For unidentified items, fill in the binomial column."
"0","diet.items <- diet.items %>% replace_na(list(binomial = 'Unidentified item'))"
"0",""
"0","# Create a table with average masses by collecting all the items of known mass..."
"0","average.sizes <- diet.items %>% drop_na(mass) %>% "
"0","  group_by(category) %>% "
"0","  ## averaging the mass for each size & class category..."
"0","  summarize(average=mean(mass)) %>% "
"0","  pivot_wider(names_from=category, values_from=average) %>% "
"0","  ## calculating the average mass for complete unknowns..."
"0","  mutate(`large item` = mean(`large bird`, `large mammal`),"
"0","         `medium item` = mean(`medium bird`, `medium mammal`),"
"0","         `small item` = mean(`small bird`, `small mammal`)) %>% "
"0","  ## and reassembling it in a tidy format."
"0","  pivot_longer(everything(), names_to='category', values_to='average')"
"0",""
"0","# Join average mass to diet items..."
"0","diet.items <- left_join(diet.items, average.sizes, by='category') %>% "
"0","  ## and fill in missing mass with average values"
"0","  mutate(mass=coalesce(mass, average)) %>% "
"0","  ## then drop no longer needed average column and rearrange."
"0","  select(id, site, year, nest, class, order, family, genus, species, binomial, common, "
"0","         category, size, mass, source)"
