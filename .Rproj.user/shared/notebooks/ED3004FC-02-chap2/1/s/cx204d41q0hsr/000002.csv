"0","# Make the initial data frame."
"0","biomass.table <- diet.items %>% group_by(class, binomial) %>% mutate(count=n()) %>% ungroup() %>% "
"0","  group_by(source) %>% mutate(total.source.count=n(), "
"0","                              total.source.mass=sum(mass)) %>% ungroup() %>% "
"0","  group_by(source, class, binomial) %>% mutate(source.count=n(), "
"0","                                               source.mass=sum(mass),"
"0","                                               per.source.count=source.count/total.source.count*100,"
"0","                                               per.source.mass=source.mass/total.source.mass*100) %>% "
"0","  distinct(source, class, binomial, count, per.source.count, per.source.mass) %>% "
"0","  mutate(source2=paste0(source, '2')) %>% "
"0","  pivot_wider(names_from=source, values_from=per.source.count) %>% "
"0","  pivot_wider(names_from=source2, values_from=per.source.mass) %>% ungroup() %>% "
"0","  group_by(class, binomial) %>% "
"0","  fill(everything(), .direction='downup') %>% "
"0","  distinct() %>% left_join(prey.list, by=c('class', 'binomial')) %>% "
"0","  select(class, common, binomial, count, C, C2, P, P2, R, R2) %>% "
"0","  mutate(common=replace_na(common, 'unknown'),"
"0","         binomial=str_replace(binomial, 'Unidentified item', ' '),"
"0","         common=str_to_sentence(common, locale='en')) %>% "
"0","  arrange(class, binomial) %>% "
"0","  rownames_to_column(var='order') %>% mutate(order=as.numeric(order)) %>% "
"0","  mutate(order=case_when("
"0","  class == 'Mammalia' ~ order + 1,"
"0","  class == 'Unknown' ~ order + 2,"
"0","  TRUE ~ order"
"0","))"
"0",""
"0","# Make it better."
"0","temp <- diet.items %>% group_by(class, binomial) %>% mutate(count=n()) %>% ungroup() %>%"
"0","  group_by(source) %>% mutate(total.source.count=n(),"
"0","                              total.source.mass=sum(mass)) %>% ungroup() %>%"
"0","  group_by(source, class, binomial) %>% mutate(source.count=n(),"
"0","                                               source.mass=sum(mass),"
"0","                                               per.source.count=source.count/total.source.count*100,"
"0","                                               per.source.mass=source.mass/total.source.mass*100) %>%"
"0","  distinct(source, class, binomial, count, per.source.count, per.source.mass) %>%"
"0","  select(source, class, binomial,count, per.source.count, per.source.mass) %>%"
"0","  mutate(source2=paste0(source, '2')) %>%"
"0","  pivot_wider(names_from=source, values_from=per.source.count) %>%"
"0","  pivot_wider(names_from=source2, values_from=per.source.mass) %>% ungroup() %>%"
"0","  group_by(class, binomial) %>%"
"0","  fill(everything(), .direction='downup') %>%"
"0","  distinct() %>% left_join(prey.list, by=c('class', 'binomial')) %>%"
"0","  select(class, common, binomial, genus, species, count, C, C2, P, P2, R, R2) %>%"
"0","  mutate(common=replace_na(common, 'unknown'),"
"0","         binomial=str_replace(binomial, 'Unidentified item', ' '),"
"0","         common=str_to_sentence(common, locale='en')) %>%"
"0","  arrange(class, binomial) %>%"
"0","  rownames_to_column(var='order') %>% mutate(order=as.numeric(order)) %>%"
"0","  mutate(order=case_when("
"0","    class == 'Mammalia' ~ order + 2,"
"0","    class == 'Unknown' ~ order + 4,"
"0","    TRUE ~ order"
"0","  )) %>%"
"0","  mutate(genus=case_when("
"0","    genus != 'NA' ~ paste0('\\textit{', genus, '}'),"
"0","    TRUE ~ genus"
"0","  )) %>%"
"0","  mutate(species=case_when("
"0","    species == 'sp' ~ 'sp.',"
"0","    species != 'sp' ~ paste0('\\textit{', species, '}'),"
"0","    genus == NA ~ NA_character_"
"0","  )) %>%"
"0","  mutate(binomial=paste(genus, species)) %>%"
"0","  mutate(binomial=case_when("
"0","    binomial == 'NA NA' ~ NA_character_,"
"0","    TRUE ~ binomial"
"0","  )) %>% ungroup() %>%"
"0","  select(-c(genus, species))"
"0",""
"0","# Find where total rows should be inserted."
"0","table.breaks <- biomass.table %>% group_by(class) %>% "
"0","  summarize(max=max(order), .groups='drop') %>% ungroup() %>% "
"0","  select(max) %>% as.vector()"
"0",""
"0","# Move the unknowns to the correct place."
"0","temp <- temp %>% mutate(order=case_when("
"0","  class == 'Aves' & common == 'Unknown' ~ table.breaks$max[1] + 1,"
"0","  class == 'Mammalia' & common == 'Unknown' ~ table.breaks$max[2] + 2,"
"0","  TRUE ~ order"
"0","))"
"0",""
"0","# Calculate total avian items."
"0","avian.sums <- biomass.table %>% filter(class == 'Aves') %>% "
"0","  ungroup() %>% "
"0","  replace(is.na(.), 0) %>%"
"0","  summarise(., across(where(is.numeric), sum)) %>%"
"0","  mutate(order=table.breaks$max[1] + 2, class='Aves', common='TOTAL', binomial=' ') %>%  "
"0","  select(order, class, common, binomial, everything())"
"0",""
"0","# Calculate total mammalian items."
"0","mammal.sums <- biomass.table %>% filter(class == 'Mammalia') %>% "
"0","  ungroup() %>% "
"0","  replace(is.na(.), 0) %>%"
"0","  summarise(., across(where(is.numeric), sum)) %>%"
"0","  mutate(order=table.breaks$max[2] + 3, class='Mammalia', common='TOTAL', binomial=' ') %>%  "
"0","  select(order, class, common, binomial, everything())"
"0",""
"0","# Calculate total items."
"0","all.sums <- biomass.table %>% ungroup() %>% "
"0","  replace(is.na(.), 0) %>%"
"0","  summarise(., across(where(is.numeric), sum)) %>%"
"0","  mutate(order=table.breaks$max[3] + 3, class=' ', common='TOTAL', binomial=' ') %>%  "
"0","  select(order, class, common, binomial, everything())"
