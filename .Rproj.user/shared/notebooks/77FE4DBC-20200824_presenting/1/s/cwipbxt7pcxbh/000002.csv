"0","# Bring in HSI data."
"0","r.hsi <- raster('../data/processed/foraging_sc.tif')"
"0",""
"0","# Define levels for HSI raster."
"0","hsi.levels <- data.frame(ID=c(-10, -2, -1, 0, 1, 2, 3), "
"0","                           class.name=c('ocean', 'freshwater', 'river', 'nil', 'low', 'moderate', 'high'))"
"0",""
"0","# Add to raster."
"0","levels(r.hsi) <- hsi.levels"
"0",""
"0","# Assign CRS."
"0","crs(r.hsi) <- CRS('+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs')"
"0",""
"0","# Make a list of metrics to calculate."
"0","hsi.metrics <- c('lsm_l_core_mn', 'lsm_l_area_mn', 'lsm_c_pland', 'lsm_l_ed',"
"0","                 'lsm_l_enn_mn', 'lsm_l_pd', 'lsm_l_contag', 'lsm_l_iji',"
"0","                 'lsm_l_prd', 'lsm_l_sidi', 'lsm_l_siei')"
"0",""
"0","# Make a function to do the calculations and formatting."
"0",""
"0","calc.hsi.metrics <- function(x) {"
"0","  sample_lsm(r.hsi, y=sites.sf, size=x, plot_id=nests, shape='circle', "
"0","             what=hsi.metrics) %>% "
"0","    left_join(hsi.levels, by=c('class'='ID')) %>% "
"0","    mutate(class.name=ifelse(is.na(class.name), metric, class.name)) %>% "
"0","    select(-class, -metric, -level) %>%  "
"0","    pivot_wider(names_from=class.name, values_from=value) %>% "
"0","    mutate(radius=x)"
"0","}"
"0",""
"0","# Run the function for each sample size."
"0","hsi.landscape.metrics <- map_df(landscape$radius, calc.hsi.metrics)"
"0",""
"0","# Do some cleanup: fill NAs with zeros and rename columns, calculate mature forest."
"0","hsi.landscape.metrics <- hsi.landscape.metrics %>% #replace(is.na(.), 0) %>% "
"0","  select(nest=plot_id, "
"0","         hsi.core=core_mn, hsi.size=area_mn, hsi.edge.density=ed,"
"0","         hsi.n.neighbor=enn_mn, hsi.patch.density=pd, hsi.contagion=contag, hsi.interspersion=iji,"
"0","         hsi.richness=prd, hsi.diversity=sidi, hsi.evenness=siei, "
"0","         hsi.freshwater=freshwater, hsi.ocean=ocean, hsi.river=river, everything(), "
"0","         -layer, -id, -percentage_inside) %>% "
"0","  mutate(amount.suitable = moderate + high)"
"0",""
"0","hsi.landscape.metrics <- select(landscape, radius, size) %>% right_join(hsi.landscape.metrics)"
"0",""
"0","save(hsi.landscape.metrics, file='../data/interim/hsi_landscape_metrics.rda')"
