"0","# Make the initial data frame."
"0","biomass.table <- diet.items %>% group_by(class, binomial) %>% mutate(count=n()) %>% ungroup() %>% "
"0","  group_by(source) %>% mutate(total.source.count=n(), "
"0","                              total.source.mass=sum(mass)) %>% ungroup() %>% "
"0","  group_by(source, class, binomial) %>% mutate(source.count=n(), "
"0","                                               source.mass=sum(mass),"
"0","                                               per.source.count=source.count/total.source.count*100,"
"0","                                               per.source.mass=source.mass/total.source.mass*100) %>% "
"0","  distinct(source, class, binomial, count, per.source.count, per.source.mass) %>% "
"0","  mutate(source2=paste0(source, '2')) %>% "
"0","  pivot_wider(names_from=source, values_from=per.source.count) %>% "
"0","  pivot_wider(names_from=source2, values_from=per.source.mass) %>% ungroup() %>% "
"0","  group_by(class, binomial) %>% "
"0","  fill(everything(), .direction='downup') %>% "
"0","  distinct() %>% left_join(prey.list, by=c('class', 'binomial')) %>% "
"0","  select(class, common, binomial, count, C, C2, P, P2, R, R2) %>% "
"0","  mutate(common=replace_na(common, 'unknown'),"
"0","         binomial=str_replace(binomial, 'Unidentified item', ' '),"
"0","         common=str_to_sentence(common, locale='en')) %>% "
"0","  arrange(class, binomial) %>% "
"0","  rownames_to_column(var='order') %>% mutate(order=as.numeric(order)) %>% "
"0","  mutate(order=case_when("
"0","  class == 'Mammalia' ~ order + 1,"
"0","  class == 'Unknown' ~ order + 2,"
"0","  TRUE ~ order"
"0","))"
"0",""
"0","# Find where total rows should be inserted."
"0","table.breaks <- biomass.table %>% group_by(class) %>% "
"0","  summarize(max=max(order), .groups='drop') %>% ungroup() %>% "
"0","  select(max) %>% as.vector()"
"0",""
"0","# Calculate total avian items."
"0","avian.sums <- biomass.table %>% filter(class == 'Aves') %>% "
"0","  ungroup() %>% "
"0","  replace(is.na(.), 0) %>%"
"0","  summarise(., across(where(is.numeric), sum)) %>%"
"0","  mutate(order=table.breaks$max[1] + 1, class='Aves', common='TOTAL', binomial=' ') %>%  "
"0","  select(order, class, common, binomial, everything())"
"0",""
"0","# Calculate total mammalian items."
"0","mammal.sums <- biomass.table %>% filter(class == 'Mammalia') %>% "
"0","  ungroup() %>% "
"0","  replace(is.na(.), 0) %>%"
"0","  summarise(., across(where(is.numeric), sum)) %>%"
"0","  mutate(order=table.breaks$max[2] + 1, class='Mammalia', common='TOTAL', binomial=' ') %>%  "
"0","  select(order, class, common, binomial, everything())"
"0",""
"0","# Calculate total items."
"0","all.sums <- biomass.table %>% ungroup() %>% "
"0","  replace(is.na(.), 0) %>%"
"0","  summarise(., across(where(is.numeric), sum)) %>%"
"0","  mutate(order=table.breaks$max[3] + 1, class=' ', common='TOTAL', binomial=' ') %>%  "
"0","  select(order, class, common, binomial, everything())"
"0",""
"0","# Make the table (flextable style)"
"0","bind_rows(biomass.table, avian.sums, mammal.sums, all.sums) %>% arrange(order) %>% "
"0","  mutate(across(C:R2, round, digits=2)) %>% "
"0","  column_to_rownames(var='order') %>% "
"0","  flextable() %>% "
"0","  add_header_row(values=c(' ', 'Camera', 'Pellets', 'Remains'), colwidths=c(4, 2, 2, 2)) %>% "
"0","  colformat_num(na_str='-', digits=0) %>% "
"0","  set_header_labels(class='Class', common='Common name', binomial='binomial', count='N',"
"0","                    C='% items', C2='% biomass',"
"0","                    P='% items', P2='% biomass',"
"0","                    R='% items', R2='% biomass')"
