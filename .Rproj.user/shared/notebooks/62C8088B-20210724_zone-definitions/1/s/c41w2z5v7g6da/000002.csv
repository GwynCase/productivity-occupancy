"0","# Bring in a list of all known prey."
"0","prey.list <- read_csv('../data/interim/prey_attributes.csv')"
"0",""
"0","# Fix the gray jay."
"0","prey.list <- prey.list %>% mutate(common=case_when("
"0","  common == 'gray jay' ~ 'canada jay',"
"0","  TRUE ~ common"
"0","))"
"0",""
"0","# Join the biomass data to the list of diet items."
"0","diet.items <- prey.list %>% select(genus, species, binomial, common, category, mass) %>% "
"0","  right_join(diet.data, by=c('genus', 'species', 'common'))"
"0",""
"0","# For unidentified items, classify them by size and class."
"0","diet.items <- diet.items %>% mutate(category=case_when("
"0","  is.na(category) & class == 'Mammalia' & size == 'small' ~ 'small mammal',"
"0","  is.na(category) & class == 'Mammalia' & size == 'medium' ~ 'medium mammal',"
"0","  is.na(category) & class == 'Mammalia' & size == 'large' ~ 'large mammal',"
"0","  is.na(category) & class == 'Aves' & size == 'small' ~ 'small bird',"
"0","  is.na(category) & class == 'Aves' & size == 'medium' ~ 'medium bird',"
"0","  is.na(category) & class == 'Aves' & size == 'large' ~ 'large bird',"
"0","  is.na(category) & class == 'Unknown' ~ paste(size, 'item'),"
"0","  TRUE ~ category))"
"0",""
"0","# For unidentified items, fill in the binomial column."
"0","diet.items <- diet.items %>% replace_na(list(binomial = 'Unidentified item'))"
"0",""
"0","# Calculate average masses for unidentified items, based of known species."
"0","mean.mass <- diet.items %>% drop_na(mass) %>% "
"0","  distinct(binomial, mass, category) %>% "
"0","  group_by(category) %>% "
"0","  ## averaging the mass for each size & class category..."
"0","  summarize(average=mean(mass)) %>% "
"0","  pivot_wider(names_from=category, values_from=average) %>% "
"0","  ## calculating the average mass for complete unknowns..."
"0","  mutate(`large item` = mean(c(`large bird`, `large mammal`)),"
"0","         `medium item` = mean(c(`medium bird`, `medium mammal`)),"
"0","         `small item` = mean(c(`small bird`, `small mammal`))) %>% "
"0","  ## and reassembling it in a tidy format."
"0","  pivot_longer(everything(), names_to='category', values_to='average')"
"0",""
"0","# Join average mass to diet items..."
"0","diet.items <- left_join(diet.items, mean.mass, by='category') %>% "
"0","  ## and fill in missing mass with average values"
"0","  mutate(mass=coalesce(mass, average)) %>% "
"0","  ## then drop no longer needed average column and rearrange."
"0","  select(site, year, nest, class, order, family, genus, species, binomial, common, "
"0","         category, size, mass, age, source)"
"0",""
"0","# Change mass for juvenile items."
"0","diet.items <- diet.items %>% mutate(mass=case_when("
"0","  age == 'J' ~ 0.5*mass,"
"0","  TRUE ~ mass"
"0","))"
"0",""
"0","# Add grouping categories."
"0","diet.items <- diet.items %>% mutate(group=case_when("
"0","  class == 'Aves' & family == 'Phasianidae' ~ 'grouse',"
"0","  class == 'Aves' & family == 'Corvidae' ~ 'corvid',"
"0","  class == 'Aves' & family == 'Turdidae' ~ 'thrush',"
"0","  class == 'Aves' ~ 'bird',"
"0","  class == 'Mammalia' & genus == 'Tamiasciurus' ~ 'squirrel',"
"0","  class == 'Mammalia' & genus == 'Lepus' ~ 'hare',"
"0","  class == 'Mammalia' ~ 'mammal',"
"0","  TRUE ~ 'unknown'"
"0","))"
