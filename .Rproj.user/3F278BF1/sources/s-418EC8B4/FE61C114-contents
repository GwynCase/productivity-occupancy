
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
options(knitr.kable.NA = '-')
```

```{r libraries, message=FALSE, warning=FALSE}
# Import conflict settings.
source('../src/conflicted.R')

# Load some libraries.
library(tidyverse)
library(lubridate)
library(sf)
library(rmapshaper)
library(ggspatial)
library(vegan)
library(broom)
library(knitr)
library(kableExtra)
library(stringr)
library(flextable)

# Make a function to round percents nicely.
peretty <- function(x, p=2) {
  as.numeric(x) %>% 
    round(p)
}
```

# Introduction

Effective wildlife conservation often requires understanding diet composition and its consequences for population demographics [@ferrer_near_2004; @stier_ecosystem_2016]. Specialist predators consume a narrow range of prey species, which increases foraging efficiency on preferred prey at the cost of decreased reproductive success for the specialist when that prey is scarce [@newton_population_1998]. Generalist predators consume a greater diversity of prey and readily switch between prey species, so are less sensitive to changes in prey abundance [@steenhof_dietary_1988; @terraube_factors_2011]. However, for a generalist predator a single key prey species may still be a major driver of reproductive success [@elmhagen_arctic_2000; @resanomayor_dietdemography_2016]. For at-risk predators, increasing the abundance of key prey species may consequentially be a useful conservation tool [@ferrer_near_2004;  @forsman_diets_2004; @resanomayor_dietdemography_2016].

<!-- Newton 1998: "Much depends on how varied the diet is, and whether alternate prey are available when favoured prey are scarce. The more diverse the diet, the less the chance of all prey-species being scarce at the same time. Raptors that have fairly stable food-supplies show some of the most extreme stability in breeding population recorded in birds.... Moreover, the same species may fluctuate numerically in one region, but not another, depending on the stability of the local prey supply." -->

<!-- Elmhagen et al. 2000: "The arctic fox thus manages to combine an opportunistic feeding strategy which ensures survival in a low productivity habitat, with a remarkable ability to exploit lemming peaks for a large reproductive output." -->

<!--Resano-Major et al 2016: "We found that several key demographic parameters of an endangered raptor such as Bonelli’s eagle in western Europe are dependent on the consumption of preferred and alternative prey species and on diet diversity." -->

<!-- Forsman et al. 2004: "Experimental tests of these hypotheses have not been conducted, but it is obvious that Spotted Owls in the Pacific Northwest rely on a few species of nocturnal mammals for the majority of their food, and that forest management practices  that produce healthy populations of these species should benefit Spotted Owls. -->

The northern goshawk (*Accipiter gentilis*) is a large forest-dwelling raptor with a Holarctic distribution. A generalist predator, the goshawk hunts a variety of small- and medium-sized mammals and birds, including squirrels, rabbits and hares, grouse, jays and crows, and pigeons [@squires_northern_2020]. Despite this diverse diet, a single prey species or narrow suite of species has a strong effect on the demographics of many goshawk populations. In the Yukon, goshawks depend on snowshoe hare (*Lepus americanus*) and show strong variation in productivity, mortality, and space use in response to cyclical changes in hare abundance [@doyle_population_1994]. Goshawks in Scandinavia likewise rely on a single prey taxon (subfamily Tetraoninae) and show changes in productivity and occupancy based on the annual abundance of four grouse species [@tornberg_delayed_2005]. In contrast, goshawks in the American Southwest have a wide prey base and regularly consume some fourteen different species [@boal_northern_1994]. Fluctuations in goshawk productivity in this region are small and driven by total prey abundance, though the most influential single species is red squirrel (*Tamiasciurus hudsonicus*) [@salafsky_reproductive_2007]. These examples suggest the identity and influence of key prey species in such an adaptable predator may be specific to each population.

In British Columbia, Canada, the coastal population of northern goshawks is the subject of federal and provincial management which focuses on the protection of breeding habitat to increase nest site availability [@cosewic_cosewic_2013]. Like many raptors, goshawks are generally considered to be limited by both nest site availability and prey abundance [@reynolds_review_2006; @rutz_population_2006]. However, current management plans contain minimal protections for foraging habitat and do not include actions to increase prey populations, in part due to a lack of knowledge regarding goshawk diet and foraging behavior in this region. 

Goshawk diet in the coastal Pacific Northwest is variable, with hawks on Vancouver Island, British Columbia, consuming primarily red squirrels [@ethier_breeding_1999], whereas hawks in nearby southeast Alaska [@lewis_northern_2006] and western Washington [@bloxton_prey_2002] consume mostly medium and large birds. The mainland coast of British Columbia is ecologically similar to Vancouver Island and hawks in this region might be predicted to consume a similar diet to hawks on Vancouver Island.
However, a gradient of forest types across the coastal mainland may produce dietary variation at fine scales. Snowshoe hare, a key prey species in many portions of the goshawk's range, is absent from Vancouver Island, scarce on the coastal mainland, and abundant in the British Columbia interior [@nagorsen_identification_2002]<!-- This citations is a faaaaaaake -->. Goshawk diet on the mainland coast may reflect this variation in available prey between Vancouver Island and the mainland, as well as the variation in prey abundance between the coast and the interior. Where coastal forest types transition to interior forest types, it is unclear how goshawk diet might respond to fine variation in prey availability and abundance. Detailed, local information on goshawk diet is therefore necessary if limiting factors beyond nest site availability are to be included in management plans.

Here we describe the breeding season diet of northern goshawks in coastal British Columbia over a two-year period using nest cameras, egested pellets, and prey remains. We assess whether goshawk diet differs within this region between the wetter *coastal* zone and the drier *transition* zone. We further evaluate whether diet composition and diet diversity influence goshawk reproductive success.

# Methods

## Study Area and Species

```{r sites, warning=FALSE, message=FALSE}
# Read in nest data.
nests <- read_csv('../data/processed/sc_nests.csv')

# Calculate a centroid for each site.
centroids <- nests %>% group_by(site) %>% 
  mutate(xcoord=mean(xcoord), ycoord=mean(ycoord)) %>% 
  distinct(site, name, xcoord, ycoord) %>% ungroup()

# Make it a spatial object for later.
centroids.sf <- centroids %>% 
  st_as_sf(coords=c('xcoord', 'ycoord')) %>% 
  st_set_crs('+proj=utm +zone=10 +datum=WGS84 +units=m +no_defs') %>% 
  st_as_sf()

# Bring in study area shapefile.
sc.region <- read_sf(dsn='../data/external/SC_land.shp', layer='SC_land')
tz.region <- read_sf(dsn='../data/processed/new_transition_zone.shp', 
                     layer='new_transition_zone') %>% 
  ms_simplify()

# Add zone information to centroids.
centroids.sf <- centroids.sf %>% mutate(
  zone=as.integer(st_intersects(geometry, tz.region)),
  zone=case_when(
    is.na(zone) ~ 'cs',
    TRUE ~ 'tz'
  )
)

# Bring in some base data.
n.america <- read_sf(dsn='../data/external/ne_10m_land.shp', layer='ne_10m_land')
rivers <- read_sf(dsn='../data/external/ne_10m_rivers_lake_centerlines.shp', 
                  layer='ne_10m_rivers_lake_centerlines')

# Make a reference point for Vancouver.
vancouver <- data.frame(x=-123.113889, y=49.260833, name='Vancouver')
```

In North America the northern goshawk ranges from the boreal forests of the Yukon south to the high-elevation forests of Arizona and New Mexico. Two subspecies are recognized: the widespread *atricapillus* and the restricted *laingi* [@squires_northern_2020].<!-- COSEWIC says 3 subssp but never even names A. g. apache --> The *laingi* subspecies was first described on the Haida Gwaii archipelago in British Columbia and is smaller and darker than the *atricapillus* subspecies found elsewhere on the continent [@taverner_variation_1940]. The range of this subspecies is limited to the west coast of North America, from southeast Alaska through mainland British Columbia and Vancouver Island, possibly as far south as Washington's Olympic Peninsula [@cosewic_cosewic_2013]. Within British Columbia the Coast Mountains form a major barrier to movement and mark the boundary between the *laingi* and *atricapillus* ranges. *A. g. laingi* is considered a species at risk in British Columbia by both the federal and provincial governments due to significant habitat loss from industrial timber harvest [@northern_goshawk_recovery_team_recovery_2008; @cosewic_cosewic_2013]. 

<!--Squires et al. 2020: "Accipiter g. atricapillus (Wilson) 1812, breeds throughout North America, except in areas occupied by other subspecies. Vagrants to the British Isles have been noted Oct-Feb (Cramp and Simmons 1980a). Compared to other subspecies, atricapillus is distinguished by its broad supercilium and deep-red iris. A. g. laingi (Taverner) Taverner 1940, breeds on Queen Charlotte Is. and Vancouver I. and is characterized by its darker coloration overall, black of crown extending to interscapulars, sootier gray ventrally, especially across the breast, and smaller size (wing length [convex distance] adult males: 325.2 mm ± 2.2 SE (n = 24; Johnson 1989b). Distribution of laingi extends from Vancouver I. northward through insular British Columbia, insular (Alexander Archipelago) and coastal mainland Alaska north to Icy Strait and Lynn Canal (Webster 1988, Titus et al. 1994, Iverson et al. 1996a). A. g. apache (van Rossem) Van Rossem 1938a, resident from s. Arizona south locally in mountains of Mexico to Jalisco is darker dorsally, almost blackish, and larger. Recognition of this race has been debated, but it is recognized by Phillips et al. (Phillips et al. 1964a), Wattel (Wattel 1973), Hubbard (Hubbard 1992), and Whaley and White (Whaley and White 1994)." -->

We conducted research in southwestern British Columbia, where goshawks are considered part of the *laingi* subspecies [@northern_goshawk_recovery_team_recovery_2008; @cosewic_cosewic_2013; but see @geraldes_population_2018). The region is characterized by rugged mountains interspersed with coastal fjords and low-lying valleys. The maritime climate supports temperate rainforest dominated by western redcedar (*Thuja plicata*), western hemlock (*Tsuga heterophylla*), and Douglas-fir (*Pseudotsuga menziesii*) [@meidinger_ecosystems_1991]. <!--The goshawk population in southwestern British Columbia is currently classified as *A. g. laingi*, though new genetic evidence may lead to future reclassification [@geraldes_population_2018].--> Within this region, goshawk managers have delineated a *transition zone* comprised of low-elevation valleys in the Coast Mountain Range which connect the coast and the interior [@northern_goshawk_recovery_team_recovery_2008]. The narrow transition zone contains temperate rainforest ecosystems which are slightly drier than the forests found further west, termed the *coastal zone*, and somewhat intermediate with the arid interior forests forests found further east (Figure \@ref(fig:study-area-map)). The transition zone may represent an area of overlap between the coastal *laingi* population and the interior *atricapillus* population [@northern_goshawk_recovery_team_recovery_2008]. 

<!-- NGRT 2008: "The precise range boundaries are unclear and there is likely some overlap between A. gentilis laingi and A. gentilis atricapillus where coastal forests transition to interior forests."

"Within this range map the recovery team identified a zone where coastal habitat types transition to interior habitat types, which reflects an area where differences between A. gentilis laingi and A. gentilis atricapillus are likely less clear." -->

## Data Collection

```{r diet-data, warning=FALSE, message=FALSE}
# Bring in specimen data.
remains.data <- read_csv('../data/processed/specimens_20210318.csv', guess_max=7000) %>% 
  ## filter only records with at least size assigned...
  filter(size != 'U')

# Bring in camera data.
photos <- read_csv('../data/interim/cameras_20210315.csv', guess_max=7000)
camera.data <- photos %>% 
  ## filter only records with at least size assigned...
  filter(size != 'U')

# Bring in a list of site abbreviations and site names.
nest.list <- read_csv('../data/processed/site_abbreviations.csv')

# Standardize the specimen data.
remains.data <- left_join(remains.data, nest.list, by=c('name', 'site')) %>% 
  select(site, date, class, order, family, genus, species, common, size, age, source)

# Standardize the camera data.
camera.data <- camera.data %>% 
  mutate(date=date(datetime), source='C') %>% 
  select(site, date, class, order, family, genus, species, common, size, age, source)

# Join them together.
diet.data <- bind_rows(remains.data, camera.data)

# Add a unique site/year identifier.
diet.data <- diet.data %>% 
  mutate(year=year(date), nest=paste(site, year, sep=''))

# Do some cleanup.
diet.data <- diet.data %>% 
  mutate(size=case_when(
    size %in% c('S', 'Small') ~ 'small',
    size %in% c('M', 'Medium') ~ 'medium',
    size %in% c('L', 'Large') ~ 'large'
  ))
```

We assessed goshawk diet during the 2019 and 2020 breeding seasons through a combination of egested pellets, prey remains, and nest camera photos. Active goshawk nests were located as part of long-term population monitoring conducted by the British Columbia Ministry of Forests, Lands, Natural Resource Operations and Rural Development (FLNRORD). For detailed survey methodology see @mcclaren_northern_2005. Some study sites contained active nests in both years of the study.

```{r}
n.pr.sites <- diet.data %>% filter(source != 'C') %>% distinct(nest) %>% 
  summarize(n()) %>% as.numeric()

n.pr.sites.2019 <- diet.data %>% filter(source != 'C' & year(date) == 2019) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()

n.pr.sites.2020 <- diet.data %>% filter(source != 'C' & year(date) == 2020) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()
```

Prey remains and egested pellets were collected from `r n.pr.sites` nests (2019 *n* = `r n.pr.sites.2019`, 2020 *n* = `r n.pr.sites.2020`). Pellets and remains were gathered from beneath active nests, from within nests after juveniles fledged, and from plucking-posts located within the site. Logistic constraints prevented more than one collection of pellets and remains at most sites, but some  sites were visited multiple times during the breeding season. All prey remains and all pellets from a collection location (one nest or one plucking post) were combined into a single sample for each visit to that location. 

```{r}
# Number of camera sites.
n.camera.sites <- diet.data %>% filter(source == 'C') %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()

# Number of camera sites in 2019.
n.camera.sites.2019 <- diet.data %>% filter(source == 'C' & year(date) == 2019) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()

# Number of camera sites in 2020.
n.camera.sites.2020 <- diet.data %>% filter(source == 'C' & year(date) == 2020) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()
```

Nest cameras were installed at a subset of these nests (2019 *n* = `r n.camera.sites.2019`, 2020 *n* = `r n.camera.sites.2020`) to record prey delivered to goshawk chicks. Nest cameras are an effective and relatively unbiased method of measuring avian diet [@garcia-salgado_evaluation_2015 ;@harrison_using_2019]. However, cameras may overestimate prey deliveries because goshawks cache prey items for redelivery to the nest at a later time, which creates a risk of double-counting items. Due to the discrete nature of our data we were unable to differentiate cached, re-delivered items from new items and did not attempt to account for caching in our analysis. We also did not attempt to differentiate between prey consumed by the female at the nest and prey consumed by the chicks.

```{r}
# Earliest date of camera install.
date.install.min <- diet.data %>% filter(source == 'C') %>% group_by(site) %>% 
  arrange(date) %>% slice(1) %>% ungroup() %>% summarize(date=min(date)) %>% 
  mutate(day=day(date), month=month(date, label=TRUE, abbr=FALSE), install=paste(day, month)) %>%
  select(install) %>% as.character()

# Latest date of camera install.
date.install.max <- diet.data %>% filter(source == 'C') %>% group_by(site) %>% 
  arrange(date) %>% slice(1) %>% ungroup() %>% summarize(date=max(date)) %>% 
  mutate(day=day(date), month=month(date, label=TRUE, abbr=FALSE), install=paste(day, month)) %>%
  select(install) %>% as.character()

# Mean camera install date.
date.install.mean <- diet.data %>% filter(source == 'C') %>% group_by(site) %>% 
  arrange(date) %>% slice(1) %>% ungroup() %>%
  mutate(ordinal=yday(date)) %>% 
  summarize(mean.ordinal=mean(ordinal)) %>% 
  mutate(date=ymd(20200101) + mean.ordinal) %>% 
  mutate(day=day(date), month=month(date, label=TRUE, abbr=FALSE), install=paste(day, month)) %>%
  select(install) %>% as.character()
```

Nest cameras were digital trail cameras (Reconyx brand, UltraFire and HyperFire models) mounted 2-5 meters distant from and slightly above the nest, usually in an adjacent tree. Cameras in 2019 were programmed to take three photos one second apart when triggered by motion, and an additional one photo every thirty minutes. Cameras in 2020 were programmed to take five photos one second apart when triggered by motion, and an additional one photo every twenty minutes. Installation took place during the early nestling phase (between `r date.install.min` and `r date.install.max`; mean installation date `r date.install.mean`) and cameras were left in place until after juveniles dispersed in the fall. Camera site selection was not random but constrained by topography, site access, and timing of nest discovery. We observed no nest abandonment following camera installation.

```{r productivity, warning=FALSE, message=FALSE}
productivity <- read_csv('../data/raw/productivity.csv')

# Number of sites with productivity data.
n.sites.productivity <- filter(productivity, !is.na(n.fledge)) %>% summarize(n()) %>% as.numeric()

# Number of sites with productivity data in 2019.
n.sites.productivity.2019 <- filter(productivity, !is.na(n.fledge) & year == 2019) %>% 
  summarize(n()) %>% as.numeric()

# Number of sites with productivity data in 2020.
n.sites.productivity.2020 <- filter(productivity, !is.na(n.fledge) & year == 2020) %>% 
  summarize(n()) %>% as.numeric()
```

Breeding chronology was not available for most sites. At `r n.sites.productivity` of the `r n.camera.sites` nests with cameras (2019 *n* = `r n.sites.productivity.2019`, 2020 *n* = `r n.sites.productivity.2020`), chicks were aged from photos taken shortly after camera installation using a pictorial guide [@boal_photographic_1994]. Productivity was defined as the number of chicks to reach 32 days of age [@boal_photographic_1994; @mcclaren_northern_2002]. 

<!-- Steenhof & Kochert 1982 define fledging  success as number of young to reach 80% of the average age when young leave the nest. Boal 1994 states this is 32 days for NOGO, and this is the definition McClaren 2002 uses. -->

## Diet Quantification

We reconstructed prey from pellets and prey remains following a modification of the protocol used by @lewis_comparison_2004. Within each sample, remains were identified to the lowest possible taxonomic category and the minimum number of individuals counted (i.e. 3 hare femurs = 2 *Lepus americanus*). Intact pellets and broken but reassembled pellets were analyzed individually within each sample, while fragmented pellets were combined within each sample. Pellets were dissected and feathers, fur, and hard parts (bones, teeth, claws) were identified to the lowest taxonomic level possible. We counted the minimum number of individuals represented within the pellet or pellet collection. Prey items from pellets and  remains were additionally categorized by size (small = sparrow- or vole-sized, medium = jay- or squirrel-sized, and large = grouse- or hare-sized).

Prey items identified to species were assigned a mass using data from the literature. We assigned mass to mammals from @nagorsen_identification_2002 and to birds from @billerman_birds_2020, using the geographically closest estimates available and averaging the mass of males and females. We treated some homogenous genera for which we could not differentiate species (such as *Eutamias* and *Myotis*) as a single taxonomic grouping. For these genera, we assigned mass by averaging the masses of all possible species, based on range maps. Red squirrels (*Tamiasciurus hudsonicus*) were present at a single site within our study area; when unable to distinguish between the two members of the genus *Tamiasciurus* we assigned the item to the more common *T. douglasii*. Unidentified grouse were common among remains; these were assigned the mean mass of the two grouse species present in our study area (*Bonasa umbellus* and *Dendragapus fulignosus*). Juveniles prey items (mainly grouse) were assigned 50% of adult mass. Unidentified items were assigned mass by averaging the masses of the identified species in that size category and taxonomic class. 

Data from prey remains and egested pellets are known to be biased indices of diet. Some authors have found combining data from both sources to produce relatively unbiased results that can serve as a helpful supplement to nest camera data [@lewis_comparison_2004; @simmons_biases_1991]. After testing for differences between pooled pellets-and-remains data and camera data we found significant differences between these two sources. We therefore report results from pellets, pooled pellets-and-remains, and cameras separately. We do not report results from prey remains alone, as diet composition estimates from prey remains are highly biased and infrequently used in raptor diet studies.<!-- citation needed -->

Nest camera photos were reviewed and each new prey item delivered to the nest was recorded and identified to species when possible. When items could not be identified to species, they were identified to the lowest possible taxonomic level. Prey items identified from photos were assigned a size category and biomass by the same method used for remains and pellets. Partial items were assigned the average mass for that size category and taxonomic class. 

```{r mass, warning=FALSE, message=FALSE}
# Bring in a list of all known prey.
prey.list <- read_csv('../data/interim/prey_attributes.csv')

# Join the biomass data to the list of diet items.
diet.items <- prey.list %>% select(genus, species, binomial, common, category, mass) %>% 
  right_join(diet.data, by=c('genus', 'species', 'common'))

# For unidentified items, classify them by size and class.
diet.items <- diet.items %>% mutate(category=case_when(
  is.na(category) & class == 'Mammalia' & size == 'small' ~ 'small mammal',
  is.na(category) & class == 'Mammalia' & size == 'medium' ~ 'medium mammal',
  is.na(category) & class == 'Mammalia' & size == 'large' ~ 'large mammal',
  is.na(category) & class == 'Aves' & size == 'small' ~ 'small bird',
  is.na(category) & class == 'Aves' & size == 'medium' ~ 'medium bird',
  is.na(category) & class == 'Aves' & size == 'large' ~ 'large bird',
  is.na(category) & class == 'Unknown' ~ paste(size, 'item'),
  TRUE ~ category))

# For unidentified items, fill in the binomial column.
diet.items <- diet.items %>% replace_na(list(binomial = 'Unidentified item'))

# Calculate average masses for unidentified items, based of known species.
mean.mass <- diet.items %>% drop_na(mass) %>% 
  distinct(binomial, mass, category) %>% 
  group_by(category) %>% 
  ## averaging the mass for each size & class category...
  summarize(average=mean(mass)) %>% 
  pivot_wider(names_from=category, values_from=average) %>% 
  ## calculating the average mass for complete unknowns...
  mutate(`large item` = mean(c(`large bird`, `large mammal`)),
         `medium item` = mean(c(`medium bird`, `medium mammal`)),
         `small item` = mean(c(`small bird`, `small mammal`))) %>% 
  ## and reassembling it in a tidy format.
  pivot_longer(everything(), names_to='category', values_to='average')

# Join average mass to diet items...
diet.items <- left_join(diet.items, mean.mass, by='category') %>% 
  ## and fill in missing mass with average values
  mutate(mass=coalesce(mass, average)) %>% 
  ## then drop no longer needed average column and rearrange.
  select(site, year, nest, class, order, family, genus, species, binomial, common, 
         category, size, mass, age, source)

# Change mass for juvenile items.
diet.items <- diet.items %>% mutate(mass=case_when(
  age == 'J' ~ 0.5*mass,
  TRUE ~ mass
))

# Add grouping categories.
diet.items <- diet.items %>% mutate(group=case_when(
  class == 'Aves' & family == 'Phasianidae' ~ 'grouse',
  class == 'Aves' & family == 'Corvidae' ~ 'corvid',
  class == 'Aves' & family == 'Turdidae' ~ 'thrush',
  class == 'Aves' ~ 'bird',
  class == 'Mammalia' & genus == 'Tamiasciurus' ~ 'squirrel',
  class == 'Mammalia' & genus == 'Lepus' ~ 'hare',
  class == 'Mammalia' ~ 'mammal',
  TRUE ~ 'unknown'
))
```

We quantified goshawk diet across the entire study area in several ways using data from pellets, pooled pellets-and-remains, and nest cameras. For ease of comparison, we simplified prey items into eight broad categories: tree squirrels (genus *Tamiasciurus*), hares (genus *Lepus*), all other mammals, grouse (subfamily Tetraoninae), thrushes (family Turdidae), corvids (family Corvidae), all other birds, and unidentified items. We calculated the relative proportion of avian and mammalian biomass, as well as the relative proportion of biomass composed of tree squirrels (genus *Tamiasciurus*), which are known to be an important source of prey for goshawks in British Columbia [@ethier_breeding_1999]. For nests with cameras, we additionally quantified diet at the level of the individual nest and further calculated diet diversity with Simpson's Diversity Index [@simpson_measurement_1949]<!-- and overlap between nests with Morisita's Index of Similarity [@krebs_ecological_1999],--> using counts of items identified to genus or better. We report all diet quantification as percent of biomass or mean percent biomass $\pm$ the standard deviation except where counts or percents of items are explicitly specified.

```{r study-area, warning=FALSE, message=FALSE}
# Make a function to calculate class mass.
class.mass <- function(data) {
    data %>% mutate(total.mass=sum(.data$mass)) %>%
    filter(class %in% c('Mammalia', 'Aves')) %>%
    group_by(class) %>% 
    mutate(class.mass=sum(.data$mass), per.class=class.mass/total.mass*100) %>% 
    distinct(class, per.class) %>% 
    rename(variable=class, percent=per.class)
}

# And a function to calculate squirrel mass.
squirrel.mass <- function(data) {
    data %>% mutate(total.mass=sum(.data$mass)) %>%
    filter(genus == 'Tamiasciurus') %>%
    mutate(genus.mass=sum(.data$mass), per.genus=genus.mass/total.mass*100) %>% 
    distinct(genus, per.genus) %>% 
    rename(variable=genus, percent=per.genus)
}

# And a function to calculate mass of each group.
group.mass <- function(data) {
  data %>% mutate(total.mass=sum(.data$mass)) %>%
    group_by(group) %>% 
    mutate(group.mass=sum(.data$mass), per.group=group.mass/total.mass*100) %>% 
    distinct(group, per.group) %>% 
    rename(variable=group, percent=per.group)
}

# Calculate biomass for study area. 
study.area.mass <- diet.items %>% group_by(source) %>% nest() %>%  
  mutate(class=map(data, class.mass), 
         genus=map(data, squirrel.mass), 
         group=map(data, group.mass)) %>%
  pivot_longer(-c(source, data), names_to='var', values_to='per') %>% 
  unnest(per) %>% 
  select(source, variable, percent) %>% 
  pivot_wider(names_from=source, values_from=percent, values_fill=0) %>% 
  mutate(R.P=R + P)
```

```{r nest-level, warning=FALSE, message=FALSE}
# Calculate percent mass for each nest.
nest.mass <- diet.items %>% filter(source == 'C') %>% 
  group_by(nest) %>% nest() %>% 
  mutate(class=map(data, class.mass), 
         genus=map(data, squirrel.mass), 
         group=map(data, group.mass)) %>% 
  pivot_longer(-c(nest, data), names_to='var', values_to='per') %>% 
  unnest(per) %>% 
  select(nest, variable, percent) %>% 
  pivot_wider(id_cols=c(nest), names_from=variable, values_from=percent, values_fill=0)

# Calculate counts of items identified to genus for entire study area.
study.area.count <- diet.items %>% filter(source == 'C' & binomial != 'Unidentified item') %>% 
  group_by(binomial) %>% 
  mutate(count=n()) %>% 
  select(binomial, count) %>% 
  distinct() %>% 
  pivot_wider(names_from=binomial, values_from=count, values_fill=list(count = 0))

# Calculate counts of items identified to genus for each nest.
nest.count <- diet.items %>% filter(source == 'C' & binomial != 'Unidentified item') %>% 
  group_by(nest, binomial) %>% 
  mutate(count=n()) %>% 
  select(nest, binomial, count) %>% 
  distinct() %>% 
  pivot_wider(names_from=binomial, values_from=count, values_fill=list(count = 0))

# Total study area diversity.
study.area.diversity <- diversity(study.area.count, index='simpson')

# Diversity per nest.
nest.diversity <- plyr::ddply(nest.count, ~nest, function(x) {
  data.frame(diet.diversity=diversity(x[-1], index='simpson'))
})

# Calculate overlap between nests.
nest.overlap <- nest.count %>% column_to_rownames(var='nest') %>% 
  vegdist(., method='morisita') %>% 
  enframe()
```

```{r zones, warning=FALSE, message=FALSE}
# Calculate % biomass for each source and each zone.
zone.mass <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
    group_by(zone, source) %>% nest() %>%  
    mutate(class=map(data, class.mass), 
           genus=map(data, squirrel.mass), 
           group=map(data, group.mass)) %>% 
    select(!data) %>% 
    pivot_longer(-c(source, zone), names_to='var', values_to='per') %>% 
    unnest(per) %>% 
    select(source, zone, variable, percent) %>% 
    pivot_wider(id_cols=c(zone, variable), names_from=source, values_from=percent, values_fill=0) %>%
    mutate(R.P=R + P) %>% 
    arrange(zone)

# Calculate counts of items identified to genus for each zone.
zone.count <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(source == 'C' & binomial != 'Unidentified item') %>% 
  group_by(zone, binomial) %>% 
  mutate(count=n()) %>% 
  select(zone, binomial, count) %>% 
  distinct() %>% 
  pivot_wider(names_from=binomial, values_from=count, values_fill=list(count = 0))

# Diversity per zone (pooled).
zone.diversity <- plyr::ddply(zone.count, ~zone, function(x) {
  data.frame(diet.diversity=diversity(x[-1], index='simpson'))
})

# Diversity per zone per nest.
zone.nest.diversity <- diet.items %>% distinct(site, nest) %>% 
  right_join(nest.diversity, by=c('nest')) %>% 
  left_join(centroids.sf, by=c('site')) %>% 
  select(site, nest, diet.diversity, zone)

# Mean diversity per nest for the transition zone.
mean.diversity.tz <- zone.nest.diversity %>% filter(zone == 'tz') %>% 
  summarize(mean(diet.diversity)) %>% peretty()

# Mean diversity per nest for the coastal zone.
mean.diversity.cs <- zone.nest.diversity %>% filter(zone == 'cs') %>% 
  summarize(mean(diet.diversity)) %>% peretty()

# Overlap between zones (pooled).
zone.overlap <- zone.count %>% column_to_rownames(var='zone') %>% 
  vegdist(., method='morisita') %>% 
  as.numeric()
```

## Statistical Analysis

Sites were classified as either coastal or transition based on whether the site was centered within the transition zone defined by @northern_goshawk_recovery_team_recovery_2008. We used counts of items assigned to the eight broad prey categories to assess differences in goshawk diet between the coastal and transition zones. We combined all data within each zone and tested each data source separately using a chi-squared test with simulated Monte Carlo *p*-values (2000 permutations) due to small sample sizes [@hope_simplified_1968]. For nests with cameras, we also calculated the proportion of squirrel biomass and diet diversity at the individual nest level and compared these between the zones using a *t*-test. Finally, we tested for differences in goshawk productivity between the two zones using a *t*-test.

<!--Due to small sample sizes, we used a permutation test (2000 permutations) to create a distribution for the test statistic (Hope 1968).-->

```{r chi-zone, warning=FALSE, message=FALSE}
# Calculate counts per group per zone per source.
zone.counts <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  group_by(source) %>% nest() %>% 
  mutate(count=map(data, function(data) {
    data %>% group_by(zone, group) %>% 
      mutate(count=n()) %>% 
      select(zone, group, count) %>% 
      distinct()
  })) %>% 
  unnest(count) %>% select(!data)

# Run a chi-square test for each data source.
zone.chi <-zone.counts %>% pivot_wider(names_from=source, values_from=count) %>% 
  mutate(RP=R + P) %>% 
  pivot_longer(cols=c('R', 'C', 'P', 'RP'), names_to='source', values_to='count') %>% 
  filter(!is.na(count)) %>% 
  group_by(source) %>% nest() %>% 
  mutate(ch=map(data, function(data) {
    data %>% pivot_wider(names_from=group, values_from=count, values_fill=0) %>% 
      column_to_rownames(var='zone') %>% 
      chisq.test(., correct=FALSE, simulate.p.value=TRUE)
  }),
        gl=map(ch, glance))
```

```{r between-years}
# Chi-square test for difference in prey groups between years.

# Calculate counts per year per source.
year.counts <- diet.items %>% 
  group_by(source) %>% nest() %>% 
  mutate(count=map(data, function(data) {
    data %>% group_by(year, group) %>% 
      mutate(count=n()) %>% 
      select(year, group, count) %>% 
      distinct()
  })) %>% 
  unnest(count) %>% select(!data)

# Run chi-square test.
year.chi <- year.counts %>% pivot_wider(names_from=source, values_from=count) %>% 
  mutate(RP=R + P) %>% 
  pivot_longer(cols=c('R', 'C', 'P', 'RP'), names_to='source', values_to='count') %>% 
  filter(!is.na(count)) %>% 
  group_by(source) %>% nest() %>% 
  mutate(ch=map(data, function(data) {
    data %>% pivot_wider(names_from=group, values_from=count, values_fill=0) %>% 
      column_to_rownames(var='year') %>% 
      chisq.test(., correct=FALSE, simulate.p.value=TRUE)
  }),
  gl=map(ch, glance))

# t-test for difference in diversity between years.

# Annotate diversity with year.
nest.diversity.w.year <- nest.diversity %>% mutate(year=str_extract(.$nest, '([0-9]{4})'))

# Run the t-test.
diversity.test.year.nest <- t.test(diet.diversity ~ year, data=nest.diversity.w.year)

# p-value for unpaired two-sample t-test for diet diversity between years.
p.value.diversity.year <- diversity.test.year.nest %>% 
  glance() %>% select(p.value) %>% peretty()

# df for t-test of diversity by year.
df.diversity.year.test <- diversity.test.year.nest %>% tidy() %>% select(parameter) %>% peretty()

# t-statistic for t-test of diversity by year.
stat.diversity.year.test <- diversity.test.year.nest %>% tidy() %>% select(statistic) %>% peretty()

# Mean diversity for 2019.
mean.diversity.2019 <- filter(nest.diversity.w.year, year == '2019') %>% 
  summarize(mean=mean(diet.diversity)) %>% 
  as.numeric() %>% peretty()

# SD diversity for 2019
sd.diversity.2019 <- filter(nest.diversity.w.year, year == '2019') %>% 
  summarize(sd=sd(diet.diversity)) %>% 
  as.numeric() %>% peretty()

# Mean diversity for 2020.
mean.diversity.2020 <- filter(nest.diversity.w.year, year == '2020') %>% 
  summarize(mean=mean(diet.diversity)) %>% 
  as.numeric() %>% peretty()

# SD diversity for 2020.
sd.diversity.2020 <- filter(nest.diversity.w.year, year == '2020') %>% 
  summarize(sd=sd(diet.diversity)) %>% 
  as.numeric() %>% peretty()

# t-test for difference in proportion squirrel between years.

# Annotate squirrel biomass with year.
nest.mass.w.year <- nest.mass
nest.mass.w.year$year <- str_extract(nest.mass.w.year$nest, '([0-9]{4})')

# Run the t-test.
squirrel.biomass.test.year.nest <- t.test(Tamiasciurus ~ year, data=nest.mass.w.year)

# p-value for unpaired two-sample t-test for squirrel biomass between years.
p.value.squirrel.year <- squirrel.biomass.test.year.nest %>% 
  glance() %>% select(p.value) %>% peretty()

# df for t-test of squirrel biomass by year.
df.squirrel.year.test <- squirrel.biomass.test.year.nest %>% tidy() %>% 
  select(parameter) %>% peretty()

# t-statistic for t-test of squirrel biomass by year.
stat.squirrel.year.test <- squirrel.biomass.test.year.nest %>% tidy() %>% 
  select(statistic) %>% peretty()

# Mean squirrel biomass for 2019.
mean.squirrel.2019 <- filter(nest.mass.w.year, year == '2019') %>% ungroup() %>% 
  summarize(mean=mean(Tamiasciurus), .groups='drop') %>% 
  as.numeric() %>% peretty()

# SD squirrel biomass for 2019
sd.squirrel.2019 <- filter(nest.mass.w.year, year == '2019') %>% ungroup() %>% 
  summarize(sd=sd(Tamiasciurus), .groups='drop') %>% 
  as.numeric() %>% peretty()

# Mean squirrel for 2020.
mean.squirrel.2020 <- filter(nest.mass.w.year, year == '2020') %>% ungroup() %>% 
  summarize(mean=mean(Tamiasciurus), .groups='drop') %>% 
  as.numeric() %>% peretty()

# SD squirrel for 2020.
sd.squirrel.2020 <- filter(nest.mass.w.year, year == '2020') %>% ungroup() %>% 
  summarize(sd=sd(Tamiasciurus), .groups='drop') %>% 
  as.numeric() %>% peretty()

# t-test for difference in between years.

# Run the t-test.
productivity.year.test <- t.test(n.fledge ~ as.factor(year), data=productivity)

# p-value for unpaired two-sample t-test for productivity between years.
p.value.productivity.year <- productivity.year.test %>% 
  glance() %>% select(p.value) %>% peretty()

# df for t-test of productivity by year.
df.productivity.year.test <- productivity.year.test %>% tidy() %>% 
  select(parameter) %>% peretty()

# t-statistic for t-test of productivity by year.
stat.productivity.year.test <- productivity.year.test %>% tidy() %>% 
  select(statistic) %>% peretty()

# Mean productivity for 2019.
mean.productivity.2019 <- filter(productivity, year == '2019') %>% ungroup() %>% 
  summarize(mean=mean(n.fledge), .groups='drop') %>% 
  as.numeric() %>% peretty()

# SD productivity for 2019
sd.productivity.2019 <- filter(productivity, year == '2019') %>% ungroup() %>% 
  summarize(sd=sd(n.fledge), .groups='drop') %>% 
  as.numeric() %>% peretty()

# Mean productivity for 2020.
mean.productivity.2020 <- filter(productivity, year == '2020') %>% ungroup() %>% 
  summarize(mean=mean(n.fledge, na.rm=TRUE), .groups='drop') %>% 
  as.numeric() %>% peretty()

# SD squirrel for 2020.
sd.productivity.2020 <- filter(productivity, year == '2020') %>% ungroup() %>% 
  summarize(sd=sd(n.fledge, na.rm=TRUE), .groups='drop') %>% 
  as.numeric() %>% peretty()
```

To determine the potential reproductive consequences of dietary variation, we examined how two aspects of diet, diet diversity and the proportion squirrel biomass in the diet, influenced productivity using linear regressions. We pooled data from both years of the study after testing for differences in prey group composition, diet diversity, proportion squirrel biomass, and productivity between years. We included all available nests in this analysis, including one site which contained an active nest in both years of the study. The presented results are not altered if variables for this site are averaged across years or a single year is randomly selected for inclusion. Because productivity data were available only from sites with nest cameras and nest-level diet data from pellets and prey remains were sparse, we performed this analysis using only diet data from nest cameras. All analyses were performed in R [@r_core_team_r_2020]. We used a significance level of *P* =  0.05 for all tests.

```{r models, warning=FALSE, message=FALSE}
# Make a happy data set for the models to use.
model.data <- productivity %>% mutate(nest=paste(site, year, sep='')) %>% 
  left_join(nest.diversity, by=c('nest')) %>% 
  left_join(nest.mass, by=c('nest')) %>%
  select(site, year, nest, n.fledge, diet.diversity, squirrel) %>% 
  filter_all(all_vars(!is.na(.)))

# Make the models.
diversity.model <- lm(n.fledge ~ diet.diversity, data=model.data)
squirrel.model <- lm(n.fledge ~ squirrel, data=model.data)
```

# Results

## Goshawk Diet

```{r}
### Pellet basic stats

# Number of prey items identified from pellets.
n.pellet.items <- diet.items %>% filter(source == 'P') %>% summarize(n()) %>% as.numeric()

# Number of nests from which pellets were collected.
n.pellet.sites <- diet.items %>% filter(source == 'P') %>% distinct(nest) %>% 
  summarize(n()) %>% as.numeric()

# Percent of pellet items identified to genus.
percent.pellets.to.genus <- diet.items %>% filter(source == 'P') %>% mutate(total=n()) %>% 
  filter(genus != 'Unknown') %>% mutate(genus=n(), to.genus=genus/total*100) %>% 
  distinct(to.genus) %>% peretty(0)

# Number of species identified from pellets.
n.species.pellets <- diet.items %>% filter(source == 'P' & binomial != 'Unidentified item') %>%
  distinct(binomial) %>% summarize(n()) %>% as.numeric()

### Basic remains stats.

# Number of prey items identified from remains.
n.remains.items <- diet.items %>% filter(source == 'R') %>% summarize(n()) %>% as.numeric()

# Number of species identified from pellets.
n.species.remains <- diet.items %>% filter(source == 'R' & binomial != 'Unidentified item') %>%
  distinct(binomial) %>% summarize(n()) %>% as.numeric()

# Number of sites from which remains were collected.
n.remains.sites <- diet.items %>% filter(source == 'R') %>% distinct(nest) %>% 
  summarize(n()) %>% as.numeric()

# Percent of remains items identified to genus.
percent.remains.to.genus <- diet.items %>% filter(source == 'R') %>% mutate(total=n()) %>%
  filter(genus != 'Unknown') %>% mutate(genus=n(), to.genus=genus/total*100) %>% 
  distinct(to.genus) %>% peretty(0)

### Pooled basic stats.

# Number of species identified from pellets and remains.
n.species.pooled <- diet.items %>% filter(source != 'C' & binomial != 'Unidentified item') %>%
  distinct(binomial) %>% summarize(n()) %>% as.numeric()
```

 unique prey species from the pooled pellets-and-remains sample (Table \@ref(tab:biomass-table)).

# Figures

```{r study-area-map, fig.cap='Map of study area (highlighted region) showing the coastal and transition zones.'}
# Make the map.
ggplot() +
  geom_sf(data=n.america, fill='lightgrey') +
  geom_sf(data=sc.region, aes(fill='darkgrey')) + 
  geom_sf(data=tz.region, aes(fill='dimgrey'), color=NA) +
  geom_sf(data=rivers) +
  coord_sf(xlim=c(st_bbox(sc.region)[1] - 0.5, st_bbox(sc.region)[3] + 0.5), 
           ylim=c(st_bbox(sc.region)[2] - 0.25, st_bbox(sc.region)[4] + 0.25)) +
  theme_void() +
  theme(panel.border=element_rect(color='black', fill=NA),
        legend.position='bottom') +
  annotation_scale(location='br') +
  annotation_north_arrow(location='br', which_north='true', 
                         pad_y=unit(1, 'cm'), style=north_arrow_minimal) +
  geom_point(data=vancouver, aes(x=x, y=y)) +
  geom_label(data=vancouver, aes(x=x, y=y, label=name), nudge_x=0.6, nudge_y=-0.1) +
  scale_fill_identity(name='Ecological zones', guide='legend', labels=c('Coastal', 'Transition'))

#panel.background=element_rect(fill='black'),
```

```{r}
# Make the initial data frame.
biomass.table <- diet.items %>% group_by(class, binomial) %>% mutate(count=n()) %>% ungroup() %>% 
  group_by(source) %>% mutate(total.source.count=n(), 
                              total.source.mass=sum(mass)) %>% ungroup() %>% 
  group_by(source, class, binomial) %>% mutate(source.count=n(), 
                                               source.mass=sum(mass),
                                               per.source.count=source.count/total.source.count*100,
                                               per.source.mass=source.mass/total.source.mass*100) %>% 
  distinct(source, class, binomial, count, per.source.count, per.source.mass) %>% 
  mutate(source2=paste0(source, '2')) %>% 
  pivot_wider(names_from=source, values_from=per.source.count) %>% 
  pivot_wider(names_from=source2, values_from=per.source.mass) %>% ungroup() %>% 
  group_by(class, binomial) %>% 
  fill(everything(), .direction='downup') %>% 
  distinct() %>% left_join(prey.list, by=c('class', 'binomial')) %>% 
  select(class, common, binomial, count, C, C2, P, P2, R, R2) %>% 
  mutate(common=replace_na(common, 'unknown'),
         binomial=str_replace(binomial, 'Unidentified item', ' '),
         common=str_to_sentence(common, locale='en')) %>% 
  arrange(class, binomial) %>% 
  rownames_to_column(var='order') %>% mutate(order=as.numeric(order)) %>% 
  mutate(order=case_when(
  class == 'Mammalia' ~ order + 1,
  class == 'Unknown' ~ order + 2,
  TRUE ~ order
))

# Find where total rows should be inserted.
table.breaks <- biomass.table %>% group_by(class) %>% 
  summarize(max=max(order), .groups='drop') %>% ungroup() %>% 
  select(max) %>% as.vector()

# Calculate total avian items.
avian.sums <- biomass.table %>% filter(class == 'Aves') %>% 
  ungroup() %>% 
  replace(is.na(.), 0) %>%
  summarise(., across(where(is.numeric), sum)) %>%
  mutate(order=table.breaks$max[1] + 1, class='Aves', common='TOTAL', binomial=' ') %>%  
  select(order, class, common, binomial, everything())

# Calculate total mammalian items.
mammal.sums <- biomass.table %>% filter(class == 'Mammalia') %>% 
  ungroup() %>% 
  replace(is.na(.), 0) %>%
  summarise(., across(where(is.numeric), sum)) %>%
  mutate(order=table.breaks$max[2] + 1, class='Mammalia', common='TOTAL', binomial=' ') %>%  
  select(order, class, common, binomial, everything())

# Calculate total items.
all.sums <- biomass.table %>% ungroup() %>% 
  replace(is.na(.), 0) %>%
  summarise(., across(where(is.numeric), sum)) %>%
  mutate(order=table.breaks$max[3] + 1, class=' ', common='TOTAL', binomial=' ') %>%  
  select(order, class, common, binomial, everything())
```

```{r biomass-table, tab.cap='Summary of prey items recorded at 33 active goshawk nests in the south coast of British Columbia in 2019-2020. Nest camera data from 13 sites, pellet data from 25 sites, and prey remains data from 30 sites'}
# Make the table (flextable style)
bind_rows(biomass.table, avian.sums, mammal.sums, all.sums) %>% arrange(order) %>% 
  mutate(across(C:R2, round, digits=2)) %>% 
  column_to_rownames(var='order') %>% 
  flextable() %>% 
  add_header_row(values=c(' ', 'Camera', 'Pellets', 'Remains'), colwidths=c(4, 2, 2, 2)) %>% 
  colformat_num(na_str='-', digits=0) %>% 
  set_header_labels(class='Class', common='Common name', binomial='binomial', count='N',
                    C='% items', C2='% biomass',
                    P='% items', P2='% biomass',
                    R='% items', R2='% biomass') %>% 
  bg(i=table.breaks$max[1]+1, bg='lightgrey', part='body') %>% 
  bg(i=table.breaks$max[2]+1, bg='lightgrey', part='body') %>% 
  bg(i=table.breaks$max[3]+1, bg='lightgrey', part='body')
```

# Literature Cited {-}