---
title: "PCA"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)
```

On the one hand, nothing may look promising because I'm using the wrong landscape variables (also, I've only looked at, like, two variables). Alternatively, I'm using the wrong response variable, ie I'm thinking about diet the wrong way. Something to think about is using PCA.

```{r}
# Load up some libraries.
library(tidyverse)
library(ggplot2)
library(ggbiplot) # This is experimental and must be installed from GitHub.
library(conflicted)

# Resolve conflicts.
conflict_prefer('mutate', 'dplyr')
conflict_prefer('select', 'dplyr')
conflict_prefer('arrange', 'dplyr')
conflict_prefer('filter', 'dplyr')
conflict_prefer('summarise', 'dplyr')
conflict_prefer('summarize', 'dplyr')

# Bring in diet data.
df <- read_csv('../data/interim/camera_corrected.csv', guess_max=7000)
source('../src/prey_attributes.R')

head(items)
```

This dataset still has that random *Tamiasciurus* sp. (I should really fix that permanently) so I'll deal with that.

```{r}
items <- items %>% mutate(common=case_when(
  genus == 'Tamiasciurus' & species == 'sp' ~ 'Douglas squirrel',
  TRUE ~ common
))
```

I'm using common because I don't have any duplicate common names and it let's me gracefully include things that are only identified to family or class.

Next I need to rearrange the data so it's summarized by site, which is basically the same as what I did for diversity and similarity analyses.

```{r}
# Twist and reorganize the data.
by.site <- items %>% group_by(site, common) %>% 
  mutate(count=n()) %>% 
  select(site, common, count) %>% 
  distinct() %>%
  pivot_wider(names_from=common, values_from=count, values_fill=list(count=0))

# Look at it.
by.site
```

Then actually run the PCA. `prcomp()` wants numerical-only data so I have to make my site names into rownames.

```{r}
# Convert site names to row names.
by.site <- by.site %>% column_to_rownames(var='site')

# Make the PCA.
diet.pca <- prcomp(by.site, center=TRUE, scale=TRUE)

# How'd it come out?
summary(diet.pca)
str(diet.pca)
```

I have this weird feeling I'm doing it wrong and that there should be more than 6 principal components, but aside from the strange number this seems to match all the examples I see online.

Maybe graphing it will help.

```{r}
ggbiplot(diet.pca, labels=rownames(by.site)) +
  xlim(-2, 2) +
  ylim(-2, 2) +
  theme_classic()
```

Well, that's not easy to read, and it doesn't seem to show a ton, anyhow. There seems to be a slight left-right split with UTZ being a bit of an outlier.

You know, it actually doesn't make much sense to include unidentified items, like "average small item." Does it make a difference if I drop those and run it again?

```{r}
# Remove unidentified items.
by.site.2 <- by.site %>% select(-`average small item`, `average medium item`)

# Make a new PCA.
diet.pca.2 <- prcomp(by.site.2, center=TRUE, scale=TRUE)

# Plot the new PCA.
ggbiplot(diet.pca.2, labels=rownames(by.site)) +
  xlim(-2, 2) +
  ylim(-2, 2) +
  theme_classic()
```

Well, that did make a slight difference. But it didn't make a clearer pattern--except perhaps that UTZ remains a bit of an oddball.

One last way of slicing it: using only identified items:

```{r}
# Select only items identified at least to genus.
to.genus <- items %>% filter(genus != 'Unknown') %>% 
  group_by(site, genus, species) %>% 
  mutate(count=n()) %>% 
  select(site, genus, species, count) %>% 
  unite(name, 2:3, sep=' ') %>% 
  distinct() %>%
  pivot_wider(names_from=name, values_from=count, values_fill=list(count=0))

# Make site names row names.
to.genus <- to.genus %>% column_to_rownames(var='site')

# Make the PCA.
genus.pca <- prcomp(to.genus, center=TRUE, scale=TRUE)

# Check it out.
ggbiplot(genus.pca, labels=rownames(size)) +
  xlim(-2, 2) +
  ylim(-2, 2) +
  theme_classic()
```

That looks... more like what a PCA should look like. It's roughly the same pattern as before, but more clear: Steller's jays are doing their own weird thing; UTZ is off in it's red-squirrel-and-flying-squirrel corner; RLK, TMC, and MTC are all kind of similar. The main difference is that TMC is more clearly doing it's own thing, just like UTZ, albeit in a different direction. But although it's prettier to look at, I'm not sure it's actually *better*.

```{r}
summary(genus.pca)
```

The first two PCs explain 36% and 24% of the variance, respectively (so a total of 60%), whereas the original PCA (with all items) explains 29% and 26% (55%) and the second PCA (with items identified to class) explains 30% and 25% (also 55%). So, yes, using only items identifed to genus does work better.