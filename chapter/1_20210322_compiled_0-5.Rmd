---
title: "Dietary Variation in the Northern Goshawk (Accipiter gentilis) in British Columbia"
output: html_notebook
always_allow_html: true
bibliography: chapter-one.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
options(knitr.kable.NA = '-')
```

```{r libraries, message=FALSE, warning=FALSE}
# Import conflict settings.
source('../src/conflicted.R')

# Load some libraries.
library(tidyverse)
library(lubridate)
library(sf)
library(rmapshaper)
library(ggspatial)
library(vegan)
library(broom)
library(knitr)
library(kableExtra)
library(stringr)

# Make a function to round percents nicely.
peretty <- function(x, p=2) {
  as.numeric(x) %>% 
    round(p)
}
```

# Introduction

Effective wildlife conservation often requires understanding diet composition and its consequences for population demographics. Specialist predators selectively consume a narrow range of prey species regardless of their abundance, whereas generalists opportunistically consume a wider range and readily switch between species in response to changes in prey abundance [@steenhof_dietary_1988; @terraube_factors_2011]. Specialization increases foraging efficiency on the preferred prey at the potential cost of decreased reproductive success for the specialist when that prey is scarce [@newton_population_1998]. However, even in a generalist predator a single key prey species can be a major driver of reproductive success [@elmhagen_arctic_2000; @resanomayor_dietdemography_2016]. For at-risk predators, increasing the abundance of key prey species may be a useful conservation tool [@ferrer_near_2004;  @forsman_diets_2004; @resanomayor_dietdemography_2016].

<!--"It has been suggested that insufficient research has been done on caribou nutrition to exclude inadequate nutrition as an alternative hypothesis for Boreal and Mountain caribou declines." -->

<!-- Newton 1998: "Much depends on how varied the diet is, and whether alternate prey are available when favoured prey are scarce. The mroe diverse the diet, the less the chance of all prey-species being scarce at the same time. Raptors that have fairly stable food-supplies show some of the most extreme stability in breeding population recorded in birds.... Moreover, the same species may fluctuate numerically in one region, but not another, depending on the stability of the local prey supply." -->

<!-- Elmhagen et al. 2000: "The arctic fox thus manages to combine an opportunistic feeding strategy which ensures survival in a low productivity habitat, with a remarkable ability to exploit lemming peaks for a large reproductive output." -->

<!--Resano-Major et al 2016: "We found that several key demographic parameters of an endangered raptor such as Bonelliâ€™s eagle in western Europe are dependent on the consumption of preferred and alternative prey species and on diet diversity." -->

<!-- Forsman et al. 2004: "Experimental tests of these hypotheses have not been conducted, but it is obvious that Spotted Owls in the Pacific Northwest rely on a few species of nocturnal mammals for the majority of their food, and that forest management practices  that produce healthy populations of these species should benefit Spotted Owls. -->

The northern goshawk (*Accipiter gentilis*) is a large forest-dwelling raptor with a Holarctic distribution. A generalist predator, the goshawk hunts a variety of small- and medium-sized mammals and birds, including squirrels, rabbits and hares, grouse, jays and crows, and pigeons [@squires_northern_2020]. Despite this diverse diet, a single prey species or narrow suite of species has a strong effect on the demographics of many goshawk populations. In the Yukon, goshawks depend on snowshoe hare (*Lepus americanus*) and show strong variation in productivity, mortality, and space use in response to cyclical changes in hare abundance [@doyle_population_1994]. Goshawks in Scandinavia likewise rely on a single prey taxa and show changes in productivity and occupancy based on the annual abundance of four grouse species (subfamily Tetraoninae) [@tornberg_delayed_2005]. In contrast, goshawks in the American Southwest have a wide prey base and regularly take some fourteen different species [@boal_northern_1994]. Fluctuations in goshawk productivity in this region are small and driven by total prey abundance, though the most influential single species is red squirrel (*Tamiasciurus hudsonicus*) [@salafsky_reproductive_2007]. These examples suggest the identity and influence of key prey species in such an adaptable predator is specific to each region.

<!-- Like many raptors, goshawk populations appear to be limited primarily by nest site availability and prey abundance [@reynolds_review_2006; @rutz_population_2006]. In North America, nest site availability is fairly well understood: nesting habitat characteristics have been widely described and nesting habitat availability has been modeled for some populations. However, the relationship between prey abundance, foraging habitat requirements, and goshawk demographics remains poorly understood. Elucidating this relationship is complicated by the fact that measuring prey abundance is not always possible due to logistic constraints. Abundance estimates may be misleading when prey abundance does not reflect prey availability [@janes_influences_1984; @beier_forest_1997] or when predators show a functional rather than numeric response to changes in prey abundance [@dupuy_numerical_2009]. In these cases, dietary variables such as composition or diversity may offer insight into factors limiting reproductive success. -->

In British Columbia, Canada, the coastal population of northern goshawks is the subject of federal and provincial management which focuses on the protection of breeding habitat to increase nest site availability [@cosewic_cosewic_2013]. Like many raptors, goshawk populations are generally considered to be limited by nest site availability as well as prey abundance [@reynolds_review_2006; @rutz_population_2006]. However, current management plans do not include protections for foraging habitat or actions to increase prey populations, in part due to a lack of knowledge regarding goshawk diet and foraging behavior in coastal BC. Goshawk diet in this region is variable, with hawks on Vancouver Island, British Columbia, consuming primarily red squirrels [@ethier_breeding_1999], whereas hawks in nearby southeast Alaska [@lewis_northern_2006] and western Washington [@bloxton_prey_2002] take mostly medium and large birds. Even within British Columbia, a gradient of forest types from wet coastal to dry interior may produce dietary variation at smaller scales [@ngrt_recovery_2008]. Detailed, local information on goshawk diet and its effect on reproductive success is necessary if limiting factors beyond nest site availability are to be included in management plans.

Here we describe the breeding season diet of northern goshawks in coastal British Columbia over a two-year period. We assess whether goshawk diet differs within this region between the wetter *coastal* zone and the drier *transition* zone. We further evaluate whether dietary variables (composition, diversity) influence goshawk reproductive success. <!-- Finally, we discuss -->

# Methods

### Study Area and Species

```{r sites, warning=FALSE, message=FALSE}
# Read in nest data.
nests <- read_csv('../data/processed/sc_nests.csv')

# Calculate a centroid for each site.
centroids <- nests %>% group_by(site) %>% 
  mutate(xcoord=mean(xcoord), ycoord=mean(ycoord)) %>% 
  distinct(site, name, xcoord, ycoord) %>% ungroup()

# Make it a spatial object for later.
centroids.sf <- centroids %>% 
  st_as_sf(coords=c('xcoord', 'ycoord')) %>% 
  st_set_crs('+proj=utm +zone=10 +datum=WGS84 +units=m +no_defs') %>% 
  st_as_sf()

# Bring in study area shapefile.
sc.region <- read_sf(dsn='../data/external/SC_land.shp', layer='SC_land')
tz.region <- read_sf(dsn='../data/processed/new_transition_zone.shp', 
                     layer='new_transition_zone') %>% 
  ms_simplify()

# Add zone information to centroids.
centroids.sf <- centroids.sf %>% mutate(
  zone=as.integer(st_intersects(geometry, tz.region)),
  zone=case_when(
    is.na(zone) ~ 'cs',
    TRUE ~ 'tz'
  )
)

# Bring in some base data.
n.america <- read_sf(dsn='../data/external/ne_10m_land.shp', layer='ne_10m_land')
rivers <- read_sf(dsn='../data/external/ne_10m_rivers_lake_centerlines.shp', 
                  layer='ne_10m_rivers_lake_centerlines')

# Make a reference point for Vancouver.
vancouver <- data.frame(x=-123.113889, y=49.260833, name='Vancouver')

# Make the map.
ggplot() +
  geom_sf(data=n.america, fill='white') +
  geom_sf(data=sc.region, fill='lightgrey') + 
  geom_sf(data=tz.region, fill='darkgrey', color=NA) +
  geom_sf(data=rivers) +
  coord_sf(xlim=c(st_bbox(sc.region)[1] - 0.5, st_bbox(sc.region)[3] + 0.5), 
           ylim=c(st_bbox(sc.region)[2] - 0.25, st_bbox(sc.region)[4] + 0.25)) +
  theme_void() +
  theme(panel.background=element_rect(fill='black'),
        panel.border=element_rect(color='black', fill=NA)) +
  annotation_scale(location='br') +
  annotation_north_arrow(location='br', which_north='true', 
                         pad_y=unit(1, 'cm'), style=north_arrow_minimal) +
  #geom_sf_text(data=rivers, aes(label=paste(name, featurecla)), nudge_y= -0.20)
  geom_point(data=vancouver, aes(x=x, y=y)) +
  geom_label(data=vancouver, aes(x=x, y=y, label=name), nudge_x=0.6, nudge_y=-0.1)
```

In North America, the northern goshawk ranges from boreal forests of the Yukon south to high-elevation forests of Arizona and New Mexico. Two subspecies are recognized: the widespread *atricapillus* and the limited *laingi* [@squires_northern_2020].<!-- COSEWIC says 3 subssp but never even names A. g. apache --> The *laingi* subspecies was first described on the Haida Gwaii archipelago in British Columbia and is smaller and darker than the *atricapillus* subspecies found elsewhere on the continent [@taverner_variation_1940]. The range of this subspecies is limited to the west coast of North America from southeast Alaska through mainland British Columbia and Vancouver Island, possibly as far south as Washington's Olympic Peninsula [@cosewic_cosewic_2013]. *A. g. laingi* is considered a species at risk in British Columbia by both the federal and provincial governments due to significant habitat loss from industrial timber harvest [@ngrt_recovery_2008; @cosewic_cosewic_2013].

<!--Squires et al. 2020: "Accipiter g. atricapillus (Wilson) 1812, breeds throughout North America, except in areas occupied by other subspecies. Vagrants to the British Isles have been noted Oct-Feb (Cramp and Simmons 1980a). Compared to other subspecies, atricapillus is distinguished by its broad supercilium and deep-red iris. A. g. laingi (Taverner) Taverner 1940, breeds on Queen Charlotte Is. and Vancouver I. and is characterized by its darker coloration overall, black of crown extending to interscapulars, sootier gray ventrally, especially across the breast, and smaller size (wing length [convex distance] adult males: 325.2 mm Â± 2.2 SE (n = 24; Johnson 1989b). Distribution of laingi extends from Vancouver I. northward through insular British Columbia, insular (Alexander Archipelago) and coastal mainland Alaska north to Icy Strait and Lynn Canal (Webster 1988, Titus et al. 1994, Iverson et al. 1996a). A. g. apache (van Rossem) Van Rossem 1938a, resident from s. Arizona south locally in mountains of Mexico to Jalisco is darker dorsally, almost blackish, and larger. Recognition of this race has been debated, but it is recognized by Phillips et al. (Phillips et al. 1964a), Wattel (Wattel 1973), Hubbard (Hubbard 1992), and Whaley and White (Whaley and White 1994)." -->

We studied goshawks in southwestern British Columbia, a region characterized by rugged mountains interspersed with coastal fjords and low-lying valleys. The maritime climate supports temperate rainforest dominated by Douglas-fir (*Pseudotsuga menziesii*), western redcedar (*Thuja plicata*), and western hemlock (*Tsuga heterophylla*) [@meidinger_ecosystems_1991]. The goshawk population in southwestern BC is currently classified as *A. g. laingi*, though new genetic evidence may lead to future reclassification [@geraldes_population_2018]. Within this region, goshawk managers have delineated a *transition zone* comprised of low-elevation valleys connecting the wet forests of the *coast zone* with the dry interior forests east of the Coast Mountains. This narrow transition zone contains forest types intermediate between the western and eastern forests and likely represents an area of overlap between the coastal *laingi* population and the interior *atricapillus* population [@ngrt_recovery_2008]. 

<!-- NGRT 2008: "The precise range boundaries are unclear and there is likely some overlap between A. gentilis laingi and A. gentilis atricapillus where coastal forests transition to interior forests."

"Within this range map the recovery team identified a zone where coastal habitat types transition to interior habitat types, which reflects an area where differences between A. gentilis laingi and A. gentilis atricapillus are likely less clear." -->

### Data Collection

```{r diet-data, warning=FALSE, message=FALSE}
# Bring in specimen data.
remains.data <- read_csv('../data/processed/specimens_20210318.csv', guess_max=7000) %>% 
  ## filter only records with at least size assigned...
  filter(size != 'U')

# Bring in camera data.
photos <- read_csv('../data/interim/cameras_20210315.csv', guess_max=7000)
camera.data <- photos %>% 
  ## filter only records with at least size assigned...
  filter(size != 'U')

# Bring in a list of site abbreviations and site names.
nest.list <- read_csv('../data/processed/site_abbreviations.csv')

# Standardize the specimen data.
remains.data <- left_join(remains.data, nest.list, by=c('name', 'site')) %>% 
  select(site, date, class, order, family, genus, species, common, size, age, source)

# Standardize the camera data.
camera.data <- camera.data %>% 
  mutate(date=date(datetime), source='C') %>% 
  select(site, date, class, order, family, genus, species, common, size, age, source)

# Join them together.
diet.data <- bind_rows(remains.data, camera.data)

# Add a unique site/year identifier.
diet.data <- diet.data %>% 
  mutate(year=year(date), nest=paste(site, year, sep=''))

# Do some cleanup.
diet.data <- diet.data %>% 
  mutate(size=case_when(
    size %in% c('S', 'Small') ~ 'small',
    size %in% c('M', 'Medium') ~ 'medium',
    size %in% c('L', 'Large') ~ 'large'
  ))
```

We assessed goshawk diet during the 2019 and 2020 breeding seasons through a combination of egested pellets, prey remains, and nest camera photos. <!-- collected from `r diet.data %>% distinct(site) %>% summarize(n()) %>% as.numeric()` nests across the coastal (*n* = `r left_join(diet.data, centroids.sf, by=c('site')) %>% distinct(site, zone) %>% filter(zone=='cs') %>% summarize(n()) %>% as.numeric()`) and transition (*n* = `r left_join(diet.data, centroids.sf, by=c('site')) %>% distinct(site, zone) %>% filter(zone=='tz') %>% summarize(n()) %>% as.numeric()`) zones.--> Active goshawk nests were located as part of long-term population monitoring conducted by the British Columbia Ministry of Forests, Lands, Natural Resource Operations and Rural Development (FLNRO) (for detailed survey methodology see @mcclaren_northern_2005). Some sites contained active nests in both years of the study.

```{r}
n.pr.sites <- diet.data %>% filter(source != 'C') %>% distinct(nest) %>% 
  summarize(n()) %>% as.numeric()

n.pr.sites.2019 <- diet.data %>% filter(source != 'C' & year(date) == 2019) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()

n.pr.sites.2020 <- diet.data %>% filter(source != 'C' & year(date) == 2020) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()
```

Prey remains and egested pellets were collected from `r n.pr.sites` nests (2019 *n* = `r n.pr.sites.2019`, 2020 *n* = `r n.pr.sites.2020`). Pellets and remains were gathered from beneath active nests, from within nests after juveniles had fledged, and from plucking posts located within the territory. All prey remains and all pellets from a collection location (i.e., one nest or one plucking post) were combined into a single sample for each visit to that location. 

```{r}
n.camera.sites.2019 <- diet.data %>% filter(source == 'C' & year(date) == 2019) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()

n.camera.sites.2020 <- diet.data %>% filter(source == 'C' & year(date) == 2020) %>% 
  distinct(nest) %>% summarize(n()) %>% as.numeric()
```

At a subset of these nests (2019 *n* = `r n.camera.sites.2019`, 2020 *n* = `r n.camera.sites.2020`), cameras were installed to record prey delivered to goshawk chicks. Nest cameras are an effective and relatively unbiased method of measuring avian diet [@garcia-salgado_evaluation_2015 ;@harrison_using_2019]. However, cameras may overestimate prey deliveries because goshawks cache prey items for redelivery to the nest at a later time, creating a risk of double-counting items. Due to the discrete nature of our data, we were unable to differentiate cached, re-delivered items from new items and did not attempt to account for caching in our analysis.

Nest cameras were digital trail cameras (Reconyx brand, UltraFire and HyperFire models) mounted 2-5 meters distant from and slightly above the nest, usually in an adjacent tree. Cameras in 2019 were programmed to take three photos one second apart when triggered by motion, and an additional one photo every thirty minutes. In 2020, cameras were programmed to take five photos one second apart when triggered by motion, and an additional one photo every twenty minutes. Installation took place during the early nestling phase (between `r diet.data %>% filter(source == 'C') %>% group_by(site) %>% arrange(date) %>% slice(1) %>% ungroup() %>% summarize(date=min(date)) %>% mutate(day=day(date), month=month(date, label=TRUE, abbr=FALSE), install=paste(day, month)) %>% select(install) %>% as.character()` and `r diet.data %>% filter(source == 'C') %>% group_by(site) %>% arrange(date) %>% slice(1) %>% ungroup() %>% summarize(date=max(date)) %>% mutate(day=day(date), month=month(date, label=TRUE, abbr=FALSE), install=paste(day, month)) %>% select(install) %>% as.character()`) and cameras were left in place until after juveniles dispersed in the fall. Camera site selection was not random but constrained by topography, access, and timing of discovery.

```{r productivity, warning=FALSE, message=FALSE}
productivity <- read_csv('../data/raw/productivity.csv')
```

Breeding chronology was not available for most sites. At `r filter(productivity, !is.na(n.fledge)) %>% summarize(n()) %>% as.numeric()` of the sites with cameras (2019 *n* = `r filter(productivity, !is.na(n.fledge) & year == 2019) %>% summarize(n()) %>% as.numeric()`, 2020 *n* = `r filter(productivity, !is.na(n.fledge) & year == 2020) %>% summarize(n()) %>% as.numeric()`), chicks were aged from photos taken shortly after camera installation using a pictorial guide [@boal_photographic_1994]. Productivity was defined as the number of chicks to reach 32 days age [@boal_photographic_1994; @mcclaren_northern_2002]. 

<!-- Steenhof & Kochert 1982 define fledging  success as number of young to reach 80% of the average age when young leave the nest. Boal 1994 states this is 32 days for NOGO, and this is the definition McClaren 2002 uses. -->

### Diet Quantification

We reconstructed prey from pellets and prey remains following a modification of the protocol used by @lewis_comparison_2004. Within each sample, prey remains were identified to the lowest possible taxonomic category and the minimum number of individuals counted (i.e. 3 hare femurs = 2 *Lepus americanus*). Intact pellets and broken but reassembled pellets were analyzed individually within each sample, while fragmented pellets were combined within each sample. Pellets were dissected and feathers, fur, and hard parts (bones, teeth, claws) were identified to the lowest taxonomic level. We counted the minimum number of individuals represented within the pellet or pellet collection. Prey items were additionally categorized by size (small = sparrow- or vole-sized, medium = jay- or squirrel-sized, and large = grouse- or hare-sized).

Prey items identified to species were assigned mass using data from the literature. We assigned mass to mammal species from @nagorsen_identification_2002 and to birds from @billerman_birds_2020, using the geographically closest estimates and averaging the mass of males and females. When unable to differentiate between species within a single, relatively homogeneous genus (such as *Eutamias* or *Myotis*), we assigned mass by averaging the masses of all possible species, based on range maps. Red squirrels (*Tamiasciurus hudsonicus*) were present at a single site within out study area; when unable to distinguish between the two members of the genus *Tamiasciurus* we assigned the item to the more common *T. douglasii*. Unidentified items were assigned mass by averaging the masses of the identified species in that size category and taxonomic class. As very few items could be successfully aged, we did not include prey age in our analysis. 

Data from prey remains and egested pellets are known to be biased indices of diet. Some authors have found combining data from both sources to produce relatively unbiased results that can serve as a helpful supplement to camera data [@lewis_comparison_2004] (Simmons et al 1991). However, after testing for differences between pooled pellets-and-remains and camera data we found significant differences between these two sources. We therefore report results from pellets and pooled pellets-and-remains separately. We do not report results from prey remains alone, as diet composition estimates from prey remains are highly biased and infrequently used in raptor diet studies.<!-- citation needed -->

Nest camera photos were reviewed and each new prey item delivered to the nest was recorded and identified to species when possible. When items could not be identified to species, they were identified to the lowest possible taxonomic level. Prey items identified from photos were assigned a size category and biomass by the same method used for remains and pellets. Partial items were assigned the average mass for that size category and taxonomic class. 

```{r mass, warning=FALSE, message=FALSE}
# Bring in a list of all known prey.
prey.list <- read_csv('../data/interim/prey_attributes.csv')

# Join the biomass data to the list of diet items.
diet.items <- prey.list %>% select(genus, species, binomial, common, category, mass) %>% 
  right_join(diet.data, by=c('genus', 'species', 'common'))

# For unidentified items, classify them by size and class.
diet.items <- diet.items %>% mutate(category=case_when(
  is.na(category) & class == 'Mammalia' & size == 'small' ~ 'small mammal',
  is.na(category) & class == 'Mammalia' & size == 'medium' ~ 'medium mammal',
  is.na(category) & class == 'Mammalia' & size == 'large' ~ 'large mammal',
  is.na(category) & class == 'Aves' & size == 'small' ~ 'small bird',
  is.na(category) & class == 'Aves' & size == 'medium' ~ 'medium bird',
  is.na(category) & class == 'Aves' & size == 'large' ~ 'large bird',
  is.na(category) & class == 'Unknown' ~ paste(size, 'item'),
  TRUE ~ category))

# For unidentified items, fill in the binomial column.
diet.items <- diet.items %>% replace_na(list(binomial = 'Unidentified item'))

# Calculate average masses for unidentified items, based of known species.
mean.mass <- diet.items %>% drop_na(mass) %>% 
  distinct(binomial, mass, category) %>% 
  group_by(category) %>% 
  ## averaging the mass for each size & class category...
  summarize(average=mean(mass)) %>% 
  pivot_wider(names_from=category, values_from=average) %>% 
  ## calculating the average mass for complete unknowns...
  mutate(`large item` = mean(c(`large bird`, `large mammal`)),
         `medium item` = mean(c(`medium bird`, `medium mammal`)),
         `small item` = mean(c(`small bird`, `small mammal`))) %>% 
  ## and reassembling it in a tidy format.
  pivot_longer(everything(), names_to='category', values_to='average')

# Join average mass to diet items...
diet.items <- left_join(diet.items, mean.mass, by='category') %>% 
  ## and fill in missing mass with average values
  mutate(mass=coalesce(mass, average)) %>% 
  ## then drop no longer needed average column and rearrange.
  select(site, year, nest, class, order, family, genus, species, binomial, common, 
         category, size, mass, age, source)

# Change mass for juvenile items.
diet.items <- diet.items %>% mutate(mass=case_when(
  age == 'J' ~ 0.5*mass,
  TRUE ~ mass
))

# Add grouping categories.
diet.items <- diet.items %>% mutate(group=case_when(
  class == 'Aves' & family == 'Phasianidae' ~ 'grouse',
  class == 'Aves' & family == 'Corvidae' ~ 'corvid',
  class == 'Aves' & family == 'Turdidae' ~ 'thrush',
  class == 'Aves' ~ 'bird',
  class == 'Mammalia' & genus == 'Tamiasciurus' ~ 'squirrel',
  class == 'Mammalia' & genus == 'Lepus' ~ 'hare',
  class == 'Mammalia' ~ 'mammal',
  TRUE ~ 'unknown'
))
```

For the overall study area, we quantified goshawk diet in several ways using data from pellets, pooled pellets-and-remains, and nest cameras. For ease of analysis, we simplified prey items into eight broad categories: squirrels (genus *Tamiasciurus*), hares (genus *Lepus*), all other mammals, grouse (subfamily Tetraoninae), thrushes (family Turdidae), corvids (family Corvidae), all other birds, and unidentified items. We calculated the relative proportion of avian and mammalian biomass delivered to nests. We also calculated the relative proportion of biomass composed of tree squirrels (genus *Tamiasciurus*), which are known to be an important source of prey for goshawks in British Columbia [@ethier_breeding_1999]. For sites with nest cameras, we also quantified diet at the individual nest level, and further calculated diet diversity with Simpson's Diversity Index [@simpson_measurement_1949]<!-- actually read this--> and overlap between nests with Morisita's Index of Similarity [@krebs_ecological_1999], using counts of items identified to genus or better. 

```{r study-area, warning=FALSE, message=FALSE}
# Make a function to calculate class mass.
class.mass <- function(data) {
    data %>% mutate(total.mass=sum(.data$mass)) %>%
    filter(class %in% c('Mammalia', 'Aves')) %>%
    group_by(class) %>% 
    mutate(class.mass=sum(.data$mass), per.class=class.mass/total.mass*100) %>% 
    distinct(class, per.class) %>% 
    rename(variable=class, percent=per.class)
}

# And a function to calculate squirrel mass.
squirrel.mass <- function(data) {
    data %>% mutate(total.mass=sum(.data$mass)) %>%
    filter(genus == 'Tamiasciurus') %>%
    mutate(genus.mass=sum(.data$mass), per.genus=genus.mass/total.mass*100) %>% 
    distinct(genus, per.genus) %>% 
    rename(variable=genus, percent=per.genus)
}

# And a function to calculate mass of each group.
group.mass <- function(data) {
  data %>% mutate(total.mass=sum(.data$mass)) %>%
    group_by(group) %>% 
    mutate(group.mass=sum(.data$mass), per.group=group.mass/total.mass*100) %>% 
    distinct(group, per.group) %>% 
    rename(variable=group, percent=per.group)
}

# Calculate biomass for study area. 
study.area.mass <- diet.items %>% group_by(source) %>% nest() %>%  
  mutate(class=map(data, class.mass), 
         genus=map(data, squirrel.mass), 
         group=map(data, group.mass)) %>%
  pivot_longer(-c(source, data), names_to='var', values_to='per') %>% 
  unnest(per) %>% 
  select(source, variable, percent) %>% 
  pivot_wider(names_from=source, values_from=percent, values_fill=0) %>% 
  mutate(R.P=R + P)
```

```{r nest-level, warning=FALSE, message=FALSE}
# Calculate percent mass for each nest.
nest.mass <- diet.items %>% filter(source == 'C') %>% 
  group_by(nest) %>% nest() %>% 
  mutate(class=map(data, class.mass), 
         genus=map(data, squirrel.mass), 
         group=map(data, group.mass)) %>% 
  pivot_longer(-c(nest, data), names_to='var', values_to='per') %>% 
  unnest(per) %>% 
  select(nest, variable, percent) %>% 
  pivot_wider(id_cols=c(nest), names_from=variable, values_from=percent, values_fill=0)

# Calculate counts of items identified to genus for entire study area.
study.area.count <- diet.items %>% filter(source == 'C' & binomial != 'Unidentified item') %>% 
  group_by(binomial) %>% 
  mutate(count=n()) %>% 
  select(binomial, count) %>% 
  distinct() %>% 
  pivot_wider(names_from=binomial, values_from=count, values_fill=list(count = 0))

# Calculate counts of items identified to genus for each nest.
nest.count <- diet.items %>% filter(source == 'C' & binomial != 'Unidentified item') %>% 
  group_by(nest, binomial) %>% 
  mutate(count=n()) %>% 
  select(nest, binomial, count) %>% 
  distinct() %>% 
  pivot_wider(names_from=binomial, values_from=count, values_fill=list(count = 0))

# Total study area diversity.
study.area.diversity <- diversity(study.area.count, index='simpson')

# Diversity per nest.
nest.diversity <- plyr::ddply(nest.count, ~nest, function(x) {
  data.frame(diet.diversity=diversity(x[-1], index='simpson'))
})

# Calculate overlap between nests.
nest.overlap <- nest.count %>% column_to_rownames(var='nest') %>% 
  vegdist(., method='morisita') %>% 
  enframe()
```

### Statistical Analysis

Sites were classified as either coastal or transition based on whether the site centroid fell within the transition zone defined by @ngrt_recovery_2008. We determined the site centroid by locating the central point between all known nests within each site. Using data from pellets, pooled pellets-and-remains, and nest cameras, we quantified the diet of each zone in the same manner as for the overall study area. 

```{r zones, warning=FALSE, message=FALSE}
# Calculate % biomass for each source and each zone.
zone.mass <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
    group_by(zone, source) %>% nest() %>%  
    mutate(class=map(data, class.mass), 
           genus=map(data, squirrel.mass), 
           group=map(data, group.mass)) %>% 
    select(!data) %>% 
    pivot_longer(-c(source, zone), names_to='var', values_to='per') %>% 
    unnest(per) %>% 
    select(source, zone, variable, percent) %>% 
    pivot_wider(id_cols=c(zone, variable), names_from=source, values_from=percent, values_fill=0) %>%
    mutate(R.P=R + P) %>% 
    arrange(zone)

# Calculate counts of items identified to genus for each zone.
zone.count <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(source == 'C' & binomial != 'Unidentified item') %>% 
  group_by(zone, binomial) %>% 
  mutate(count=n()) %>% 
  select(zone, binomial, count) %>% 
  distinct() %>% 
  pivot_wider(names_from=binomial, values_from=count, values_fill=list(count = 0))

# Diversity per zone (pooled).
zone.diversity <- plyr::ddply(zone.count, ~zone, function(x) {
  data.frame(diet.diversity=diversity(x[-1], index='simpson'))
})

# Diversity per zone per nest.
zone.nest.diversity <- diet.items %>% distinct(site, nest) %>% 
  right_join(nest.diversity, by=c('nest')) %>% 
  left_join(centroids.sf, by=c('site')) %>% 
  select(site, nest, diet.diversity, zone)

# Mean diversity per nest for the transition zone.
mean.diversity.tz <- zone.nest.diversity %>% filter(zone == 'tz') %>% 
  summarize(mean(diet.diversity)) %>% peretty()

# Mean diversity per nest for the coastal zone.
mean.diversity.cs <- zone.nest.diversity %>% filter(zone == 'cs') %>% 
  summarize(mean(diet.diversity)) %>% peretty()

# Overlap between zones (pooled).
zone.overlap <- zone.count %>% column_to_rownames(var='zone') %>% 
  vegdist(., method='morisita') %>% 
  as.numeric()

# Difference between zone diversity (unpooled).
unpooled.zone.diversity.test <- t.test(diet.diversity ~ zone, data=zone.nest.diversity, 
                                       var.equal=TRUE) %>% 
  glance() %>% select(p.value) %>% peretty()
```

We pooled all data within each source (cameras, pellets, pooled pellets and remains) and within each zone (coastal, transition) and tested for differences between the zones with a chi-squared test using counts of items.

```{r chi-zone, warning=FALSE, message=FALSE}
# Calculate counts per group per zone per source.
zone.counts <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  group_by(source) %>% nest() %>% 
  mutate(count=map(data, function(data) {
    data %>% group_by(zone, group) %>% 
      mutate(count=n()) %>% 
      select(zone, group, count) %>% 
      distinct()
  })) %>% 
  unnest(count) %>% select(!data)

# Run a chi-square test for each data source.
zone.chi <-zone.counts %>% pivot_wider(names_from=source, values_from=count) %>% 
  mutate(RP=R + P) %>% 
  pivot_longer(cols=c('R', 'C', 'P', 'RP'), names_to='source', values_to='count') %>% 
  filter(!is.na(count)) %>% 
  group_by(source) %>% nest() %>% 
  mutate(ch=map(data, function(data) {
    data %>% pivot_wider(names_from=group, values_from=count, values_fill=0) %>% 
      column_to_rownames(var='zone') %>% 
      chisq.test(., correct=FALSE, simulate.p.value=TRUE)
  }),
        gl=map(ch, glance))
```

To determine the potential reproductive consequences of dietary variation, we examined how two aspects of diet, diet diversity and proportion of biomass composed of squirrel, influenced productivity. We used linear regressions in R [@r_core_team_r_2020] with productivity as the response variable and diet as the explanatory variable. Because productivity data were available only from sites with nest cameras and nest-level diet data from pellets and prey remains were sparse, we performed this analysis using only diet data from nest cameras.

```{r models, warning=FALSE, message=FALSE}
# Make a happy data set for the models to use.
model.data <- productivity %>% mutate(nest=paste(site, year, sep='')) %>% 
  left_join(nest.diversity, by=c('nest')) %>% 
  left_join(nest.mass, by=c('nest')) %>%
  select(site, year, nest, n.fledge, diet.diversity, squirrel) %>% 
  filter_all(all_vars(!is.na(.)))

# Make the models.
diversity.model <- lm(n.fledge ~ diet.diversity, data=model.data)
squirrel.model <- lm(n.fledge ~ squirrel, data=model.data)
```

# Results

## Goshawk Diet

```{r}
biomass.table <- diet.items %>% group_by(class, binomial) %>% mutate(count=n()) %>% ungroup() %>% 
  group_by(source) %>% mutate(total.source.count=n(), 
                              total.source.mass=sum(mass)) %>% ungroup() %>% 
  group_by(source, class, binomial) %>% mutate(source.count=n(), 
                                               source.mass=sum(mass),
                                               per.source.count=source.count/total.source.count*100,
                                               per.source.mass=source.mass/total.source.mass*100) %>% 
  distinct(source, class, binomial, count, per.source.count, per.source.mass) %>% 
  mutate(source2=paste0(source, '2')) %>% 
  pivot_wider(names_from=source, values_from=per.source.count) %>% 
  pivot_wider(names_from=source2, values_from=per.source.mass) %>% ungroup() %>% 
  group_by(class, binomial) %>% 
  fill(everything(), .direction='downup') %>% 
  distinct() %>% left_join(prey.list, by=c('class', 'binomial')) %>% 
  select(class, common, binomial, count, C, C2, P, P2, R, R2) %>% 
  mutate(common=replace_na(common, 'unknown'),
         binomial=str_replace(binomial, 'Unidentified item', NA_character_),
         common=str_to_sentence(common, locale='en')) %>% 
  arrange(class, binomial)

biomass.table %>% 
  kable(digits=1, col.names=c('Class', 'Species', ' ', 'N',
                              '% items', '% biomass', 
                              '% items', '% biomass', 
                              '% items', '% biomass')) %>% 
  kable_styling(bootstrap_options=c('striped')) %>% 
  column_spec(3, italic=TRUE) %>% 
  add_header_above(c(' '=4, 'Camera'=2, 'Pellets'=2, 'Remains'=2))
```

We identified a total of `r diet.items %>% filter(source == 'P') %>% summarize(n()) %>% as.numeric()` prey items from pellets collected at `r diet.items %>% filter(source == 'P') %>% distinct(site) %>% summarize(n()) %>% as.numeric()` sites. Of these, `r diet.items %>% filter(source == 'P') %>% mutate(total=n()) %>% filter(genus != 'Unknown') %>% mutate(genus=n(), to.genus=genus/total*100) %>% distinct(to.genus) %>% peretty(0)`% could be identified to genus or better, and no item could not be identified at least to class. From pellets alone, only `r diet.items %>% filter(source == 'P' & binomial != 'Unidentified item') %>% distinct(binomial) %>% summarize(n()) %>% as.numeric()` unique prey species or homogenous genera (i.e. *Neotamias*) were identified. Another `r diet.items %>% filter(source == 'R') %>% summarize(n()) %>% as.numeric()` items were identified from prey remains collected at `r diet.items %>% filter(source == 'R') %>% distinct(site) %>% summarize(n()) %>% as.numeric()` sites, of which `r diet.items %>% filter(source == 'R') %>% mutate(total=n()) %>% filter(genus != 'Unknown') %>% mutate(genus=n(), to.genus=genus/total*100) %>% distinct(to.genus) %>% peretty(0)`% were identified to genus or better and none could not be identified to class. From the combined pellets-and-remains sample a total of `r diet.items %>% filter(source != 'C' & binomial != 'Unidentified item') %>% distinct(binomial) %>% summarize(n()) %>% as.numeric()` unique prey species or homogenous genera were identified.

The majority of the prey items identified from pellets were mammals (`r filter(diet.items, source == 'P') %>% mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% mutate(class=sum(mass), to.m=class/total*100) %>% distinct(to.m) %>% peretty(0)`% biomass, `r filter(diet.items, source == 'P') %>% mutate(total=n()) %>% filter(class == 'Mammalia') %>% mutate(class=n(), to.m=class/total*100) %>% distinct(to.m) %>% peretty(0)`% count). Squirrels made up `r filter(diet.items, source == 'P') %>% mutate(total=sum(mass)) %>% filter(genus == 'Tamiasciurus') %>% mutate(gen.mass=sum(mass), to.g=gen.mass/total*100) %>% distinct(to.g) %>% peretty(0)`% of biomass (`r filter(diet.items, source == 'P') %>% mutate(total=n()) %>% filter(genus == 'Tamiasciurus') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% of counts), while other birds (neither grouse, corvids, nor thrushes) made up another `r filter(diet.items, source == 'P') %>% mutate(total=sum(mass)) %>% filter(group == 'bird') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% (`r filter(diet.items, source == 'P') %>% mutate(total=n()) %>% filter(group == 'bird') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% by count) and other mammals (neither tree squirrels nor hares) made up `r filter(diet.items, source == 'P') %>% mutate(total=sum(mass)) %>% filter(group == 'mammal') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% of biomass (`r filter(diet.items, source == 'P') %>% mutate(total=n()) %>% filter(group == 'mammal') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% of counts). The remaining `r filter(diet.items, source == 'P') %>% mutate(total=sum(mass)) %>% filter(group %in% c('corvid', 'thrush')) %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% of biomass (`r filter(diet.items, source == 'P') %>% mutate(total=n()) %>% filter(group %in% c('corvid', 'thrush')) %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% of counts) was made up of corvids and thrushes. 

The combined pellets-and-remains sample showed a very different composition, with only `r filter(diet.items, source != 'C') %>% mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% of the diet made up of mammals and the majority made up of birds. The most commonly identified prey group was grouse (`r filter(diet.items, source != 'C') %>% mutate(total=sum(mass)) %>% filter(group == 'grouse') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% biomass, `r filter(diet.items, source != 'C') %>% mutate(total=n()) %>% filter(group == 'grouse') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% counts), followed by other birds (`r filter(diet.items, source != 'C') %>% mutate(total=sum(mass)) %>% filter(group == 'bird') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% biomass, `r filter(diet.items, source != 'C') %>% mutate(total=n()) %>% filter(group == 'bird') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% counts). Squirrels made up only `r filter(diet.items, source != 'C') %>% mutate(total=sum(mass)) %>% filter(group == 'squirrel') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% (`r filter(diet.items, source != 'C') %>% mutate(total=n()) %>% filter(group == 'squirrel') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% counts) of the combined sample

We recorded a total of `r photos %>% filter(!is.na(class)) %>% nrow() %>% as.numeric()` prey item deliveries on nest cameras, though camera effectiveness varied between sites: an average of `r filter(diet.items, source == 'C') %>% group_by(nest) %>% summarize(n=n(), .groups='drop') %>% summarize(mean(n)) %>% peretty(0)` items were recorded per site, but one site had only one item recorded while another recorded `r filter(diet.items, source == 'C') %>% group_by(nest) %>% summarize(n=n(), .groups='drop') %>% summarize(max(n)) %>% as.numeric()` items. This variability was due to differences in camera placement and sensitivity settings. Some deliveries were obscured from the camera during delivery and consumption and were entirely removed from the analysis. Of the remaining `r filter(diet.items, source == 'C') %>% nrow() %>% as.numeric()` visible items we were able to identify `r filter(diet.items, source == 'C') %>% mutate(total=n()) %>% filter(class != 'Unknown') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% to class and `r filter(diet.items, source == 'C') %>% mutate(total=n()) %>% filter(genus != 'Unknown') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% to genus or better. Small and medium birds were disproportionately represented among items only identified to class, frequently arriving at the nest already plucked and decapitated.

```{r}

### Class = Aves
### Level = Study area

# Calculate percent avian biomass for camera data for the entire study area.
percent.avian.biomass.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=sum(mass)) %>% filter(class == 'Aves') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)

# Calculate percent counts of avian items for camera data for the entire study area.
count.avian.items.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=n()) %>% filter(class == 'Aves') %>% 
  mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)

### Class = Aves
### Level = Nest

# Calculate mean percent avian biomass per nest.
percent.avian.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(class == 'Aves') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(mean(to.mass)) %>% peretty(0)

# Calculate standard deviation of avian biomass per nest.
sd.avian.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(class == 'Aves') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(sd(to.mass)) %>% peretty(0)

### Class = Unknown
### Level = Study area

# Calculate percent unidentified biomass for camera data for the entire study area.
percent.unknown.biomass.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=sum(mass)) %>% filter(class == 'Unknown') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)

# Calculate percent counts of unidentified items for camera data for the entire study area.
count.unknown.items.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=n()) %>% filter(class == 'Unknown') %>% 
  mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)

### Class = Unknown
### Level = Nest

# Calculate mean percent unknown biomass per nest.
percent.unknown.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(class == 'Unknown') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(mean(to.mass)) %>% peretty(0)

# Calculate standard deviation of unknown biomass per nest.
sd.unknown.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(class == 'Unknown') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(sd(to.mass)) %>% peretty(0)

### Group = Squirrels
### Level = Study area

# Calculate percent squirrel biomass for camera data for the entire study area.
percent.squirrel.biomass.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=sum(mass)) %>% filter(group == 'squirrel') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)

# Calculate percent counts of squirrels for camera data for the entire study area.
count.squirrel.items.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=n()) %>% filter(group == 'squirrel') %>% 
  mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)

### Group = Squirrel
### Level = Nest

# Calculate mean percent squirrel biomass per nest.
percent.squirrel.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'squirrel') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(mean(to.mass)) %>% peretty(0)

# Calculate standard deviation of squirrel biomass per nest.
sd.squirrel.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'squirrel') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(sd(to.mass)) %>% peretty(0)

### Group = Other mammals
### Level = Study area

# Calculate percent other mammal biomass for camera data for the entire study area.
percent.other.mammal.biomass.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=sum(mass)) %>% filter(group == 'mammal') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)

# Calculate percent counts of other mammals for camera data for the entire study area.
count.other.mammal.items.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=n()) %>% filter(group == 'mammal') %>% 
  mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)

### Group = Other mammal
### Level = Nest

# Calculate mean percent other mammal biomass per nest.
percent.other.mammal.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'mammal') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(mean(to.mass)) %>% peretty(0)

# Calculate standard deviation of other mammal biomass per nest.
sd.other.mammal.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'mammal') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(sd(to.mass)) %>% peretty(0)

### Group = Unknown
### Level = Study area

# Calculate percent unknown biomass for camera data for the entire study area.
percent.unk.gr.biomass.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=sum(mass)) %>% filter(group == 'unknown') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)

# Calculate percent counts of unknown for camera data for the entire study area.
count.unk.gr.items.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=n()) %>% filter(group == 'unknown') %>% 
  mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)

### Group = Unknown
### Level = Nest

# Calculate mean percent unknown biomass per nest.
percent.unk.gr.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'unknown') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(mean(to.mass)) %>% peretty(0)

# Calculate standard deviation of unknown biomass per nest.
sd.unk.gr.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'unknown') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(sd(to.mass)) %>% peretty(0)

### Group = Thrushes
### Level = Study area

# Calculate percent other thrush biomass for camera data for the entire study area.
percent.thrush.biomass.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=sum(mass)) %>% filter(group == 'thrush') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)

# Calculate percent counts of other thrushes for camera data for the entire study area.
count.thrush.items.study.area <- filter(diet.items, source == 'C') %>% 
  mutate(total=n()) %>% filter(group == 'thrush') %>% 
  mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)

### Group = Thrush
### Level = Nest

# Calculate mean percent thrush biomass per nest.
percent.thrush.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'thrush') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(mean(to.mass)) %>% peretty(0)

# Calculate standard deviation of thrush biomass per nest.
sd.thrush.biomass.nest <- filter(diet.items, source == 'C') %>% group_by(nest) %>%
  mutate(total=sum(mass)) %>% filter(group == 'thrush') %>% 
  mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% 
  ungroup() %>% summarize(sd(to.mass)) %>% peretty(0)

# Mean nest diversity.
mean.nest.diversity <- mean(nest.diversity$diet.diversity) %>% round(2)

# Standard deviation of nest diversity.
sd.nest.diversity <- sd(nest.diversity$diet.diversity) %>% round(2)

# Mean nest overlap.
mean.nest.overlap <- mean(nest.overlap$value) %>% round(2)

# Standard deviation of nest overlap.
sd.nest.overlap <- sd(nest.overlap$value) %>% round(2)
```

We identified `r filter(diet.items, source == 'C') %>% distinct(binomial) %>% nrow() -1` different prey species or homogenous genera on nest cameras. By biomass, mammals made up the largest proportion of prey (`r filter(diet.items, source == 'C') %>% mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(to.mass) %>% peretty(0)`% biomass, `r filter(diet.items, source == 'C') %>% mutate(total=n()) %>% filter(class != 'Mammalia') %>% mutate(count=n(), to.count=count/total*100) %>% distinct(to.count) %>% peretty(0)`% count; mean % biomass = `r filter(diet.items, source == 'C') %>% group_by(nest) %>% mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% ungroup() %>% summarize(mean(to.mass)) %>% peretty(0)`, sd = `r filter(diet.items, source == 'C') %>% group_by(nest) %>% mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% mutate(mass=sum(mass), to.mass=mass/total*100) %>% distinct(nest, to.mass) %>% ungroup() %>% summarize(sd(to.mass)) %>% peretty(0)`), which was driven by the overwhelming dominance of tree squirrels (*Tamiasciurus* spp.). Birds accounted for only `r percent.avian.biomass.study.area`% of biomass (`r count.avian.items.study.area`% counts; mean % biomass = `r percent.avian.biomass.nest`, sd = `r sd.avian.biomass.nest`), and the remaining `r percent.unknown.biomass.study.area`% could not be identified to class (`r count.unknown.items.study.area` counts; mean % biomass = `r percent.unknown.biomass.nest`, sd = `r sd.unknown.biomass.nest`). The most commonly identified prey categories by biomass were squirrels (`r percent.squirrel.biomass.study.area`% biomass, `r count.squirrel.items.study.area`% count, mean % biomass = `r percent.squirrel.biomass.nest`, sd = `r sd.squirrel.biomass.nest`), other mammals (`r percent.other.mammal.biomass.study.area`% biomass, `r count.other.mammal.items.study.area`% count, mean % biomass = `r percent.other.mammal.biomass.nest`, sd = `r sd.other.mammal.biomass.nest`), unidentified items (`r percent.unk.gr.biomass.study.area`% biomass, `r count.unk.gr.items.study.area`% count, mean % biomass = `r percent.unk.gr.biomass.nest`, sd = `r sd.unk.gr.biomass.nest`), and thrushes (`r percent.thrush.biomass.study.area`% biomass, `r count.thrush.items.study.area`% count, mean % biomass = `r percent.thrush.biomass.nest`, sd = `r sd.thrush.biomass.nest`). Based on items identified to genus or better, overall diet diversity for the study area was moderate (x = `r round(study.area.diversity, 2)`). Diet diversity of individual nests was highly variable (mean = `r mean.nest.diversity`, sd = `r sd.nest.diversity`) and overlap between nests was low but also variable. (mean = `r mean.nest.overlap`, sd = `r sd.nest.overlap`).

## Difference between ecological regions

```{r}
# Number of transition zone sites.
n.tz.cam.sites <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(zone == 'tz' & source == 'C') %>% distinct(nest) %>% 
  summarize(n()) %>% as.numeric()

# Number of coastal zone sites.
n.cs.cam.sites <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(zone == 'cs' & source == 'C') %>% distinct(nest) %>% 
  summarize(n()) %>% as.numeric()

### Comparison of mammals between zones.

# Mean proportion mammalian biomass in transition zone.
percent.mammal.biomass.tz <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(zone == 'tz' & source == 'C') %>% group_by(nest) %>% 
  mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% 
  mutate(mmass=sum(mass), cmass=mmass/total*100) %>% 
  distinct(nest, cmass) %>% ungroup() %>% summarize(mean(cmass)) %>% peretty(0)

# Mean proportion mammalian biomass in coastal zone.
percent.mammal.biomass.cs <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(zone == 'cs' & source == 'C') %>% group_by(nest) %>% 
  mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% 
  mutate(mmass=sum(mass), cmass=mmass/total*100) %>% 
  distinct(nest, cmass) %>% ungroup() %>% summarize(mean(cmass)) %>% peretty(0)

# Percent mammalian biomass per nest, by zone.
percent.mammal.biomass.zone.nest <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(source == 'C') %>% group_by(nest) %>% 
  mutate(total=sum(mass)) %>% filter(class == 'Mammalia') %>% 
  mutate(mmass=sum(mass), cmass=mmass/total) %>% 
  distinct(zone, nest, cmass)

# P-value for unpaired two-sample t-test for mammal biomass between zones.
p.value.mammal.biomass.zone <- t.test(cmass ~ zone, 
                                      data=percent.mammal.biomass.zone.nest, var.equal=TRUE) %>% 
  glance() %>% select(p.value) %>% peretty()

### Comparison of squirrels between zones.

# Mean proportion squirrel biomass in transition zone.
percent.squirrel.biomass.tz <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(zone == 'tz' & source == 'C') %>% group_by(nest) %>% 
  mutate(total=sum(mass)) %>% filter(genus == 'Tamiasciurus') %>% 
  mutate(mmass=sum(mass), cmass=mmass/total*100) %>% 
  distinct(nest, cmass) %>% ungroup() %>% summarize(mean(cmass)) %>% peretty(0)

# Mean proportion squirrel biomass in coastal zone.
percent.squirrel.biomass.cs <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(zone == 'cs' & source == 'C') %>% group_by(nest) %>% 
  mutate(total=sum(mass)) %>% filter(genus == 'Tamiasciurus') %>% 
  mutate(mmass=sum(mass), cmass=mmass/total*100) %>% 
  distinct(nest, cmass) %>% ungroup() %>% summarize(mean(cmass)) %>% peretty(0)

# Percent squirrel biomass per nest, by zone.
percent.squirrel.biomass.zone.nest <- left_join(diet.items, centroids.sf, by=c('site')) %>% 
  filter(source == 'C') %>% group_by(nest) %>% 
  mutate(total=sum(mass)) %>% filter(genus == 'Tamiasciurus') %>% 
  mutate(mmass=sum(mass), cmass=mmass/total) %>% 
  distinct(zone, nest, cmass)

# P-value for unpaired two-sample t-test for squirrel biomass between zones.
p.value.squirrel.biomass.zone <- t.test(cmass ~ zone, 
                                      data=percent.squirrel.biomass.zone.nest, var.equal=TRUE) %>% 
  glance() %>% select(p.value) %>% peretty()
```

Based on data from nest cameras, nests in the transition zone (*n* = `r n.tz.cam.sites`) received a slightly higher mean proportion of biomass from mammalian prey than did nests in the coastal zone (*n* = `r n.cs.cam.sites`; `r percent.mammal.biomass.tz`% and `r percent.mammal.biomass.cs`%, respectively), but this difference was not significant (*p* = `r p.value.mammal.biomass.zone`). Likewise, the proportion of biomass composed of tree squirrels was equally high in both the transition zone (`r percent.squirrel.biomass.tz`%) and coastal zone (`r percent.squirrel.biomass.cs`%; *p* = `r p.value.squirrel.biomass.zone`). Diet diversity was slightly higher in the transition zone (`r round(zone.diversity[2, 2], 2)`) than the coastal zone (`r round(zone.diversity[1, 2], 2)`). Diet overlap between the two zones was also high (x).

```{r}
# Test statistic for pellet data chi-squared test.
x.stat.pellet <- zone.chi %>% filter(source == 'P') %>% unnest(gl) %>% ungroup() %>% 
  select(statistic) %>% peretty()

# P value for pellet data chi-squared test.
p.value.pellet <- zone.chi %>% filter(source == 'P') %>% unnest(gl) %>% ungroup() %>% 
  select(p.value) %>% peretty()

# Test statistic for combined pellets-and-remains data chi-squared test.
x.stat.rp <- zone.chi %>% filter(source == 'RP') %>% unnest(gl) %>% ungroup() %>% 
  select(statistic) %>% peretty()

# P value for combined pellet-and-remains data chi-squared test.
p.value.rp <- zone.chi %>% filter(source == 'RP') %>% unnest(gl) %>% ungroup() %>% 
  select(p.value) %>% peretty()

# Test statistic for camera data chi-squared test.
x.stat.camera <- zone.chi %>% filter(source == 'C') %>% unnest(gl) %>% ungroup() %>% 
  select(statistic) %>% peretty()

# P value for camera data chi-squared test.
p.value.camera <- zone.chi %>% filter(source == 'C') %>% unnest(gl) %>% ungroup() %>% 
  select(p.value) %>% peretty()
```

A chi-squared test of pellet data alone did not show a significant difference between goshawk diet in the coastal and transition zones (X = `r x.stat.pellet`, *p* = `r p.value.pellet`). However, a chi-squared test of the pooled pellet-and-remains data did show a significant difference (X = `r x.stat.rp`, *p* = `r p.value.rp`), as did a test of the camera data (X = `r x.stat.camera`, *p* = `r p.value.camera`).

## Productivity

We observed no nest abandonment following camera installation. One nest in 2019 failed 9 days after installation when two chicks succumbed to siblicide and the third appeared to fledge prematurely. Two cameras' memory cards filled prior to fledging, and no productivity data is available for these sites. The remaining `r filter(productivity, !is.na(n.fledge)) %>% nrow()` nests all fledged at least one chick. Successful nests fledged 1 (*n* = `r filter(productivity, n.fledge == 1) %>% nrow()`), 2 (*n* = `r filter(productivity, n.fledge == 2) %>% nrow()`), or 3 (*n* = `r filter(productivity, n.fledge == 3) %>% nrow()`) chicks. Siblicide was observed in four other nests, which lost one chick each.<!-- MTF & MTC in 2019, MTF & GOW in 2020 -->

```{r}
# Calculate productivity for each nest by zone.
productivity.zone <- left_join(productivity, centroids.sf, by=c('site', 'name')) %>% 
  select(site, year, n.fledge, zone) %>% 
  mutate(nest=paste0(site, year))

p.value.productivity.zone <- t.test(n.fledge ~ zone, data=productivity.zone) %>% glance() %>% 
  select(p.value) %>% peretty()
```

We found no affect on goshawk productivity of either the proportion of diet composed of squirrel biomass (*p* = `r glance(squirrel.model) %>% select(p.value) %>% peretty()`) or diet diversity (*p* = `r glance(diversity.model) %>% select(p.value) %>% peretty()`). There was also no significant difference in goshawk productivity between the coastal and transitional zones (*p* = `r p.value.productivity.zone`).

# Discussion

Northern goshawks are a generalist predator known to consume a broad range of prey species across their global distribution, but not all prey species contribute equally. A single key prey species often contributes disproportionately to goshawk diet, and the identity of this species may be specific to each goshawk population. In coastal British Columbia we found goshawks consumed 22 different species during the breeding season, but the majority of their diet was composed of tree squirrels in the genus *Tamiasciurus*. Across the entire study area this single taxa made up x% of the total biomass recorded, with the percent biomass at individual nests ranging from % to %. Despite this clear dominance, the proportion of tree squirrel biomass in the diet did not influence productivity, nor did dietary diversity.

Across much of North America the key goshawk prey species is usually mammalian, often from the family Leporidae or Sciuridae [@boal_northern_1994; @doyle_population_1994; @destefano_ecology_2006; @miller_effects_2014]. However, in the coastal temperate rainforests of the Pacific Northwest goshawk diet generally contains more birds than mammals and the key prey is usually a species of grouse (subfamily Tetraoninae) [@watson_prey_1998; @thraikill_diet_2000; @bloxton_prey_2002; @lewis_northern_2006]. <!-- Watson uses pooled pellets + remains and finds 47.1:52.6% biomass birds:mammals in western Washington. --> Despite inhabiting coastal rainforest, goshawks on Vancouver Island, BC, consume primarily red squirrels (*T. hudsonicus*), with this single species making up x% of the diet [@ethier_breeding_1999]. Our results from the coastal mainland of BC are consistent with findings from Vancouver Island and more broadly with results from the interior of North America, but stand in contrast to findings from other areas in the Pacific Northwest.

The variation in key prey species between goshawk populations reflects the diversity of habitats which goshawks inhabit. Within our study area, low-elevation mountain valleys bridge the wet forests of the coast and the dry forests of the interior, creating a narrow region of intermediate habitat types where coastal and interior goshawk populations may overlap [@ngrt_recovery_2008]. At this smaller scale, we found evidence of a difference in diet composition and diversity between the coastal and transition zones. However, the identity of the key prey, tree squirrels, was the same in both zones and comprised an equally large proportion of the diet in each. This suggests that, while transition zone habitats give hawks access to a wider range of prey species than coastal zone habitats, these alternate prey fail to replace tree squirrels in importance.

<!-- Within our study area, low-elevation mountain valleys bridge the wet forests of the coast and the dry forests of the interior, creating a narrow region where coastal and interior goshawk populations may overlap [@ngrt_recovery_2008]. This transition zone provided us with a fortuitous opportunity to examine dietary variation over intermediate scales. Just as our study area is slightly drier than other regions of the coastal Pacific Northwest, the transition zone is slightly drier than the majority of our study area. --><!--Other authors have speculated the dominance of avian prey in the diet of coastal Pacific Northwest goshawks is due to lower abundance or availability of mammalian prey in temperate rainforest ecosystems (Rutz et al 2006, McClaren et al 2015). --><!--We might therefore expect hawks in the transition zone to consume more or more variety of mammalian prey than hawks in the coastal zone. We did find a significant difference in diet between the transition and coastal zones, with hawks in the transition zone consuming a more diverse diet with a greater proportion of mammalian prey, but we found no difference in either the consumption of tree squirrels or in goshawk productivity. This similarity between ecological zones supports the conclusion that, although goshawks may opportunistically hunt prey species which are locally available, they specialize on a single high-value prey resource which strongly influences their reproductive success.-->

Multiple studies have found a link between the abundance of a key prey taxa and goshawk demographics, including reproductive success. Following the assumption that a generalist predator consumes prey species relative to their abundance, diet composition may be used as proxy for prey abundance, although this assumption has rarely been made in raptors (but see so-and-so) and never in goshawks. Under this assumption, if tree squirrel abundance influences goshawk productivity, the proportion of squirrel biomass delivered to a nest should be related to the number of young fledged. Alternatively, a highly diverse diet may indicate a diverse prey base which buffers against fluctuations in the abundance of any single prey species. Our study found no support for either hypothesis. There is evidence that goshawks select prey in proportion to their abundance, but also that goshawks can be highly specialized. Without data on prey abundance within our study sties it is difficult to draw any strong conclusions regarding goshawk selectivity and its reproductive consequences; however, it is notable that the only nest in our study to experience a complete breeding failure received the smallest proportion of squirrel biomass of any nest.

Our conclusions are complicated by the multiple methods of collecting and measuring diet data used in our and other studies. We used three methods to collect data on goshawk diet--egested pellets, prey remains, and nest cameras--and found significant differences between the results they produced. Cameras are widely considered one of the least biased methods for measuring diet at the nest in raptors [@tornberg_assessing_2007; @garcia-salgado_evaluation_2015; @harrison_using_2019]. We therefore consider our results from nest cameras to be the truest approximation of goshawk diet, although we acknowledge that cameras are not entirely free of bias source. Compared to cameras, prey remains were the most biased, grossly overestimating the proportion avian biomass in the diet. For this reasons we did not analyze prey remains separately, but the pooled pellets-and-remains sample was also biased toward avian prey.  Pellets alone were the least biased in coarse composition, but severely underestimated species richness. Measuring diet composition by counts or biomass adds further uncertainty, with counts overestimating avian prey relative to biomass. These complex results highlight the importance of clearly reporting the source and measurement of raptor diet data. Because all of these methods have been used in past studies we believe there is value in reporting the results of each for ease of comparison. However, we recommend future diet studies prioritize collecting data via cameras, either video or still images, rather than physical specimens. 

Our study addresses a fundamental question regarding the basic ecology of an at-risk population of northern goshawks, but many more remain unanswered. While nest cameras are an effective way to measure prey delivered to the nest they cannot record prey consumed by adults away from the nest, prey consumed by juveniles after they have fledged, or prey consumed during the winter. As a result, we captured an incomplete picture of breeding season diet and have no insight into nonbreeding season diet. Additionally, we collected no data on prey abundance and so cannot draw conclusions regarding goshawk prey selection or individual specialization. These limitations are not exclusive to our work: few studies have successfully combined prey abundance with both goshawk diet and reproductive success and no North American study has comprehensively addressed goshawk diet away from the nest [@rutz_population_2006; @squires_northern_2006]. Filling these gaps represents an important step for future studies which seek to improve goshawk management in British Columbia and elsewhere in the species' range.

# Literature Cited